<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKLCH Theme Generator</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%23111'/%3E%3C/svg%3E">
  <style>
    :root {
      --bg-page:     #0e0e14;
      --bg-surface:  #16162a;
      --bg-code:     #0a0a12;
      --border:      #2a2a3a;
      --border-sub:  #18182a;
      --text-hi:     #e0e0e0;
      --text-mid:    #aaa;
      --text-low:    #777;
      --text-dim:    #666;
      --text-faint:  #555;
      --text-info:   #999;
      --accent:      #4a7aaa;
      --accent-bg:   #2a4a6a;
      --accent-text: #8cb4ff;
      --focus-ring:  rgba(74,122,170,0.15);
      --toast-bg:    #222;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-page); color: var(--text-hi);
      padding: 2.5rem 3rem; min-height: 100vh;
      transition: background-color 0.35s ease, color 0.35s ease;
    }
    h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.3rem; color: #fff; }
    .subtitle { font-size: 0.85rem; color: var(--text-low); margin-bottom: 2rem; line-height: 1.5; }

    /* ── Controls row ─────────────────────────────────────── */
    .controls-row {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
    }
    .controls-left  { display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0; align-items: flex-start; }
    .controls-right { display: flex; flex-direction: column; gap: 0.6rem; align-items: flex-start; margin-bottom: 2rem; }

    /* ── Input area ───────────────────────────────────────── */
    .color-input-wrapper {
      display: flex; align-items: center; gap: 0.5rem;
      background: var(--bg-surface); border: 1px solid var(--border-hi);
      border-radius: 6px; padding: 0.5rem 0.75rem;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .color-input-wrapper:focus-within {
      border-color: var(--accent); box-shadow: 0 0 0 3px var(--focus-ring);
    }
    .color-preview-swatch {
      width: 36px; height: 36px; border-radius: 5px;
      border: 2px solid rgba(255,255,255,0.1); cursor: pointer; flex-shrink: 0;
    }
    #hexInput, #bgHexInput, #errorHexInput {
      background: transparent; border: none; color: #fff;
      font-size: 1.1rem; font-family: 'Cascadia Code','Fira Code',monospace;
      width: 8ch; outline: none;
    }
    #hexInput::placeholder, #bgHexInput::placeholder, #errorHexInput::placeholder { color: var(--text-faint); }
    #colorPicker, #bgColorPicker, #errorColorPicker { position: absolute; opacity: 0; width: 0; height: 0; }

    /* ── Color inputs container ────────────────────────────── */
    .color-pair-groups-row {
      display: flex; gap: 0.75rem; align-items: stretch;
      margin-bottom: 1.25rem; flex-wrap: wrap;
    }
    .color-pair-group {
      display: flex; flex-direction: column; flex: 1; min-width: 140px;
      border: 1px solid var(--border-hi); border-radius: 8px; overflow: hidden;
      background: var(--bg-surface);
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .color-input-col {
      display: flex; flex-direction: column; gap: 0.3rem;
      padding: 1rem 1.25rem;
    }
    .color-input-col:not(:last-child) { border-bottom: 1px solid var(--border-hi); }
    .color-surface-auto {
      opacity: 0.65; font-size: 0.6rem; font-weight: 400;
      text-transform: none; letter-spacing: 0; color: var(--text-faint);
    }
    .color-col-label {
      font-size: 0.65rem; color: var(--text-dim); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.07em;
    }
    .color-col-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    .auto-btn {
      font-size: 0.6rem; padding: 0.15rem 0.45rem; border-radius: 3px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text-dim); cursor: pointer; font-family: inherit; font-weight: 600;
      transition: background 0.15s, color 0.15s, border-color 0.15s; letter-spacing: 0.04em;
    }
    .auto-btn.active { background: var(--accent-bg); color: var(--accent-text); border-color: var(--accent); }
    .input-info {
      font-size: 0.75rem; color: var(--text-dim);
      font-family: 'Cascadia Code','Fira Code',monospace;
    }
    .input-info span { color: var(--accent-text); }

    /* ── Mode switch ──────────────────────────────────────── */
    .mode-switch {
      display: flex; background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 5px; overflow: hidden;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .mode-option {
      padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600;
      cursor: pointer; transition: background 0.15s, color 0.15s;
      color: var(--text-dim); border: none; background: transparent;
      font-family: inherit; white-space: nowrap;
    }
    .mode-option:first-child { border-right: 1px solid var(--border); }
    .mode-option:hover { color: var(--text-mid); }
    .mode-option.active { background: var(--accent-bg); color: #fff; }
    .mode-hint { font-size: 0.7rem; color: var(--text-faint); font-style: italic; }

    /* ── Chroma slider ────────────────────────────────────── */
    .chroma-section { margin-bottom: 1.75rem; }
    .chroma-header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; margin-bottom: 0.6rem;
    }
    .chroma-header-left { display: flex; flex-direction: column; gap: 0.2rem; }
    .chroma-title { font-size: 1.15rem; color: var(--text-hi); font-weight: 600; }
    .chroma-hint-text { font-size: 0.7rem; color: var(--text-faint); font-style: italic; }
    .chroma-row { display: flex; align-items: center; }
    .chroma-sublabels { display: flex; justify-content: space-between; margin-top: 0.35rem; }
    .chroma-label { font-size: 0.75rem; color: var(--text-dim); white-space: nowrap; }
    .chroma-input {
      background: var(--bg-surface); border: 1px solid var(--border-hi);
      border-radius: 6px; color: var(--accent-text);
      font-size: 1rem; font-family: 'Cascadia Code','Fira Code',monospace;
      width: 7ch; padding: 0.3rem 0.5rem; outline: none;
      text-align: center; cursor: text; flex-shrink: 0;
    }
    .chroma-input:focus { border-color: var(--accent); color: #fff; }

    /* ── Seed Colors header ───────────────────────────────── */
    .seed-colors-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.6rem;
    }
    .seed-colors-title { font-size: 1.15rem; color: var(--text-hi); font-weight: 600; }
    .share-btn {
      font-size: 0.8rem; padding: 0.45rem 1.1rem; border-radius: 6px;
      border: 1px solid var(--accent); background: var(--accent-bg);
      color: var(--accent-text); cursor: pointer; font-family: inherit; font-weight: 600;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .share-btn:hover { filter: brightness(1.15); }
    .add-accent-btn {
      font-size: 0.7rem; padding: 0.3rem 0.75rem; border-radius: 5px;
      border: 1px solid var(--accent); background: var(--accent-bg);
      color: var(--accent-text); cursor: pointer; font-family: inherit; font-weight: 600;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .add-accent-btn:hover { filter: brightness(1.15); }
    .add-accent-btn:disabled { opacity: 0.4; cursor: default; filter: none; }
    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.3rem;
    }
    input[type=range] {
      flex: 1; -webkit-appearance: none; appearance: none;
      height: 8px; border-radius: 4px;
      background: var(--border); outline: none; cursor: pointer;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px;
      border-radius: 50%; background: var(--accent);
      border: 2px solid var(--bg-page);
      transition: background 0.35s ease, border-color 0.35s ease;
    }
    input[type=range]::-moz-range-thumb {
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); border: 2px solid var(--bg-page);
      transition: background 0.35s ease;
    }

    /* ── Section titles ───────────────────────────────────── */
    .section-title {
      font-size: 1.15rem; font-weight: 600; color: var(--text-hi);
      margin-top: 2.5rem; margin-bottom: 0.25rem;
    }
    .section-title.first { margin-top: 0; }
    .section-desc { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1rem; }

    /* ── Surface demo ─────────────────────────────────────── */
    .surface-demo {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem; margin-bottom: 2rem;
    }
    @media (max-width: 900px)  { .surface-demo { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 500px)  { .surface-demo { grid-template-columns: 1fr; } }
    .surface-panel { border-radius: 20px; padding: 1.1rem; }
    .surface-panel h3 { font-size: 0.8rem; margin-bottom: 0.6rem; font-weight: 600; }
    .surface-panel .mode-tag {
      font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.08em;
      opacity: 0.5; margin-bottom: 0.15rem;
    }
    .surface-card { border-radius: 12px; padding: 0.65rem 0.75rem; margin-bottom: 0.5rem; }
    .surface-card p { font-size: 0.65rem; opacity: 0.85; }
    .surface-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.65rem; }
    .surface-btn {
      display: inline-block; padding: 0.5rem 1.1rem; border-radius: 5px;
      font-size: 0.65rem; font-weight: 600; border: none; cursor: default;
      font-family: inherit; letter-spacing: 0.02em;
    }

    /* ── SVG Panel Animation ──────────────────────────────── */
    .svg-anim-palette {
      animation: svg-float-palette 5s ease-in-out 1 forwards;
      transform-origin: 100px 120px;
    }
    .svg-anim-brush {
      animation: svg-swipe-brush 4s cubic-bezier(0.4, 0, 0.2, 1) 1 forwards;
      transform-origin: 0px 0px;
    }
    .svg-anim-splash {
      animation: svg-splash-pop 4s ease-in-out 1 forwards;
      transform-origin: 135px 120px;
    }
    @keyframes svg-float-palette {
      0%   { transform: translateY(0px) rotate(0deg); }
      100% { transform: translateY(-4px) rotate(2deg); }
    }
    @keyframes svg-swipe-brush {
      0%   { transform: translate(145px, 80px) rotate(-30deg) scale(1, 1); }
      25%  { transform: translate(140px, 95px) rotate(-45deg) scale(1, 1); }
      40%  { transform: translate(135px, 120px) rotate(-60deg) scale(1.15, 0.85); }
      55%  { transform: translate(95px, 115px) rotate(-75deg) scale(1, 1); }
      75%  { transform: translate(115px, 85px) rotate(-15deg) scale(1, 1); }
      100% { transform: translate(145px, 80px) rotate(-30deg) scale(1, 1); }
    }
    @keyframes svg-splash-pop {
      0%, 36%, 55%, 100% { transform: scale(0); opacity: 0; }
      40%  { transform: scale(1); opacity: 1; }
      48%  { transform: scale(1.6); opacity: 0; }
    }

    /* ── Detail table ─────────────────────────────────────── */
    table {
      width: 100%; border-collapse: collapse; font-size: 0.78rem;
      font-family: 'Cascadia Code','Fira Code',monospace; margin-bottom: 2rem;
    }
    th {
      text-align: left; padding: 0.45rem 0.65rem; border-bottom: 1px solid var(--border);
      color: var(--text-low); font-weight: 500; font-size: 0.65rem;
      text-transform: uppercase; letter-spacing: 0.08em;
    }
    td { padding: 0.45rem 0.65rem; border-bottom: 1px solid var(--border-sub); }
    tr:hover td { background: rgba(255,255,255,0.025); }
    .color-dot {
      width: 24px; height: 24px; border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.22); display: inline-block; vertical-align: middle;
    }
    .zone-tag {
      font-size: 0.55rem; padding: 1px 6px; border-radius: 3px;
      font-family: 'Segoe UI',system-ui,sans-serif; font-weight: 600;
      letter-spacing: 0.03em; white-space: nowrap;
    }
    .zone-tag.light { background: rgba(100,160,255,0.1); color: #6aa8e8; }
    .zone-tag.dark  { background: rgba(80,200,120,0.1);  color: #5cb87a; }
    .zone-tag.hc    { background: rgba(200,120,80,0.1);  color: #c88050; }

    .copyable {
      cursor: pointer; padding: 1px 5px; border-radius: 3px;
      transition: background 0.15s; position: relative; user-select: all;
    }
    .copyable:hover { background: rgba(255,255,255,0.08); }
    .copyable.copied { background: rgba(80,200,120,0.2) !important; }

    /* ── Semantic tab distinction ─────────────────────────── */
    .semantic-info {
      display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;
    }
    .semantic-badge {
      font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
      padding: 0.2rem 0.55rem; border-radius: 4px;
      background: var(--accent-bg); color: var(--accent-text); border: 1px solid var(--accent);
      white-space: nowrap;
    }
    .semantic-note { font-size: 0.7rem; color: var(--text-dim); font-style: italic; }
    .code-block-semantic { border-left: 3px solid var(--accent); }

    .toast {
      position: fixed; bottom: 1.5rem; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--toast-bg); color: #fff; padding: 0.6rem 1.2rem; border-radius: 5px;
      font-size: 0.8rem; font-family: 'Cascadia Code','Fira Code',monospace;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; z-index: 100;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .code-block {
      background: var(--bg-code); border: 1px solid var(--border); border-radius: 5px;
      padding: 1.1rem 1.25rem; font-family: 'Cascadia Code','Fira Code',monospace;
      font-size: 0.7rem; line-height: 1.6; overflow-x: auto; white-space: pre;
      color: var(--text-info); margin-bottom: 1rem; position: relative;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .copy-block-btn {
      position: absolute; top: 0.6rem; right: 0.6rem;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-info); font-size: 0.65rem; padding: 0.3rem 0.6rem; border-radius: 4px;
      cursor: pointer; font-family: inherit; transition: background 0.15s, color 0.15s;
    }
    .copy-block-btn:hover { background: rgba(255,255,255,0.1); color: #ccc; }
    .copy-block-btn.copied { background: rgba(80,200,120,0.15); color: #6fc; border-color: rgba(80,200,120,0.3); }

    .tab-bar { display: flex; gap: 0; margin-bottom: 0; }
    .tab-btn {
      padding: 0.55rem 1.2rem; font-size: 0.75rem; font-weight: 600;
      background: transparent; border: 1px solid var(--border); border-bottom: none;
      color: var(--text-dim); cursor: pointer; border-radius: 5px 5px 0 0;
      transition: background 0.15s, color 0.15s; font-family: inherit;
    }
    .tab-btn:hover { color: var(--text-mid); background: rgba(255,255,255,0.02); }
    .tab-btn.active { color: #fff; background: var(--bg-surface); border-color: var(--border); }
    .sub-tab-bar { display: flex; gap: 0.3rem; margin-bottom: 0.85rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border); }
    .sub-tab-btn {
      font-size: 0.65rem; padding: 0.2rem 0.65rem; border-radius: 4px;
      border: 1px solid var(--border); background: transparent; color: var(--text-dim);
      cursor: pointer; font-family: inherit; font-weight: 600; transition: background 0.12s, color 0.12s;
    }
    .sub-tab-btn:hover { color: var(--text-mid); }
    .sub-tab-btn.active { background: rgba(255,255,255,0.08); color: #fff; border-color: var(--border-hi); }
    .sub-tab-content { display: none; }
    .sub-tab-content.active { display: block; }
    .tab-content {
      display: none; border: 1px solid var(--border); border-radius: 0 5px 5px 5px;
      padding: 1.5rem; background: var(--bg-surface);
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .tab-content.active { display: block; }
    .tab-content > table { margin-bottom: 0; }

    .section-card {
      background: var(--bg-surface); border: 1px solid var(--border-hi);
      border-radius: 12px; padding: 1.25rem; margin-bottom: 2rem;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .section-card .section-title { margin-top: 0; }
    .section-card > .tab-group { margin-bottom: 0 !important; }

    #output { display: none; }
    #output.visible { display: block; }

    /* ── Mobile ───────────────────────────────────────────── */
    @media (max-width: 600px) {
      body { padding: 1.25rem 1rem; }
      h1 { font-size: 1.3rem; }

      /* Seed Colors / Share */
      .seed-colors-header { margin-bottom: 0.5rem; }

      /* Color inputs: stack cards vertically on mobile */
      .color-pair-groups-row { flex-direction: column; gap: 0.5rem; }
      .color-pair-group { min-width: 0; }
      .color-input-col { padding: 0.75rem 1rem; }
      .input-info { font-size: 0.65rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      /* Mode switch: full width */
      .controls-right { width: 100%; }
      .mode-switch { width: 100%; }
      .mode-option { flex: 1; text-align: center; }

      /* Tabs: smaller padding, allow wrap */
      .tab-bar { flex-wrap: wrap; }
      .tab-btn { padding: 0.4rem 0.75rem; font-size: 0.7rem; }

      /* Tables: horizontal scroll */
      .tab-content { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { min-width: 520px; }

      /* Surface demo: reduce SVG height */
      [style*="height:130px"] { height: 90px !important; }

      /* Semantic info: allow wrap */
      .semantic-info { flex-wrap: wrap; }
      /* Accent inputs: wrap rows */
      .accent-row { flex-wrap: wrap; }
      .accent-name-input { width: 8ch; }
    }

    /* ── Accent Inputs ────────────────────────────────────── */
    .accent-inputs-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.6rem;
    }
    .accent-row {
      display: flex; align-items: center; gap: 0.75rem;
      background: var(--bg-surface); border: 1px solid var(--border-hi);
      border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .accent-swatch {
      width: 28px; height: 28px; border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.22); cursor: pointer; flex-shrink: 0;
    }
    .accent-hex-input {
      background: transparent; border: none; color: #fff;
      font-size: 1rem; font-family: 'Cascadia Code','Fira Code', monospace;
      width: 7ch; outline: none;
    }
    .accent-name-input {
      background: transparent; border: none; outline: none;
      font-size: 0.65rem; color: var(--text-dim); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.07em;
      font-family: 'Segoe UI', system-ui, sans-serif; width: 100%;
    }
    .accent-name-input:focus { color: var(--accent-text); }
    .accent-delete-btn {
      margin-left: auto; font-size: 0.65rem; padding: 0.2rem 0.5rem;
      border-radius: 3px; border: 1px solid var(--border);
      background: transparent; color: var(--text-dim); cursor: pointer;
      font-family: inherit; transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .accent-delete-btn:hover { border-color: #cc4444; color: #cc4444; }

    /* ── Accent Mini-Cards in Surface Preview ─────────────── */
    .accent-mini-card {
      border-radius: 8px; padding: 0.4rem 0.6rem; margin-top: 0.4rem;
      font-size: 0.6rem; font-weight: 600; border: 1.5px solid transparent;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .accent-mini-card-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
  </style>
</head>
<body>

  <div class="page-header">
    <h1>OKLCH Theme Generator</h1>
    <button class="share-btn" onclick="copyShareLink()">Share Theme</button>
  </div>
  <p class="subtitle">
    Define <strong>Brand</strong>, <strong>Surface</strong> and <strong>Error</strong> seed colors &rarr; generates perceptually uniform <strong>Primitive Token</strong> scales in the OKLCH color space, maps them to ready-to-use <strong>Semantic Tokens</strong> (shadcn/ui compatible), and previews your theme across Light, Dark and High Contrast modes.
  </p>

  <div class="seed-colors-header">
    <span class="seed-colors-title">Seed Colors</span>
  </div>
  <div class="color-pair-groups-row">
    <!-- Brand pair: Brand action + Surface -->
    <div class="color-pair-group">
      <div class="color-input-col">
        <div class="color-col-header">
          <span class="color-col-label">Brand</span>
          <button class="auto-btn" id="brandPinBtn" onclick="toggleBrandPin()">Pin</button>
        </div>
        <div class="color-input-wrapper">
          <div class="color-preview-swatch" id="swatchPreview" style="background:#335A7F" onclick="document.getElementById('colorPicker').click()"></div>
          <input type="color" id="colorPicker" value="#335A7F">
          <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
          <input type="text" id="hexInput" value="335A7F" placeholder="335A7F" maxlength="7" spellcheck="false">
        </div>
      </div>
      <div class="color-input-col">
        <div class="color-col-header">
          <span class="color-col-label">Surface</span>
          <button class="auto-btn active" id="bgAutoBtn" onclick="toggleBgAutoMatch()">Auto</button>
        </div>
        <div class="color-input-wrapper">
          <div class="color-preview-swatch" id="bgSwatchPreview" style="background:#335A7F" onclick="document.getElementById('bgColorPicker').click()"></div>
          <input type="color" id="bgColorPicker" value="#335A7F">
          <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
          <input type="text" id="bgHexInput" value="335A7F" placeholder="335A7F" maxlength="7" spellcheck="false">
        </div>
      </div>
    </div>
    <!-- Error pair -->
    <div class="color-pair-group">
      <div class="color-input-col">
        <div class="color-col-header">
          <span class="color-col-label">Error</span>
          <div style="display:flex;gap:0.25rem">
            <button class="auto-btn active" id="errorAutoBtn" onclick="toggleErrorAutoMatch()">Auto</button>
            <button class="auto-btn" id="errorPinBtn" onclick="toggleErrorPin()">Pin</button>
          </div>
        </div>
        <div class="color-input-wrapper">
          <div class="color-preview-swatch" id="errorSwatchPreview" style="background:#CC3333" onclick="document.getElementById('errorColorPicker').click()"></div>
          <input type="color" id="errorColorPicker" value="#CC3333">
          <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
          <input type="text" id="errorHexInput" value="CC3333" placeholder="CC3333" maxlength="7" spellcheck="false">
        </div>
      </div>
      <div class="color-input-col">
        <span class="color-col-label">Surface <span class="color-surface-auto">auto</span></span>
        <div class="color-input-wrapper">
          <div class="color-preview-swatch" id="errorSurfacePreview" style="background:var(--bg-surface)"></div>
          <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
          <span id="errorSurfaceHex" style="font-size:1.1rem;font-family:'Cascadia Code','Fira Code',monospace;color:var(--text-dim)">—</span>
        </div>
      </div>
    </div>
  </div>
  <div class="accent-inputs-header">
    <span class="seed-colors-title" style="font-size:0.95rem">Additional Accents</span>
    <button class="add-accent-btn" id="addAccentBtn" onclick="addAccent()">+ Add Accent</button>
  </div>
  <div id="accentInputsContainer"></div>
  <div class="controls-right">
    <div class="mode-switch">
      <button class="mode-option active" data-mode="balanced" onclick="setMode('balanced')">Balanced Midpoint</button>
      <button class="mode-option" data-mode="exact" onclick="setMode('exact')">Exact Brand Match</button>
    </div>
    <div class="mode-hint" id="modeHint">500 = perceptual midpoint (L=0.50) &mdash; palette is symmetric around the brightest point of the hue</div>
  </div>

  <div id="output">

    <!-- ── Chroma slider ───────────────────────────────────── -->
    <div class="chroma-section">
      <div class="chroma-header">
        <div class="chroma-header-left">
          <span class="chroma-title">Surface Chroma</span>
          <span class="chroma-hint-text">Chroma intensity for background and surface tokens</span>
        </div>
        <input type="text" class="chroma-input" id="chromaInput" value="25%" maxlength="5">
      </div>
      <div class="chroma-row">
        <input type="range" id="chromaSlider" min="0" max="100" value="25">
      </div>
      <div class="chroma-sublabels">
        <span class="chroma-label">Grey</span>
        <span class="chroma-label">Vibrant</span>
      </div>
    </div>

    <!-- ── Surface demo ────────────────────────────────────── -->
    <span class="chroma-title" style="display:block;margin-bottom:0.75rem">Theme Preview</span>
    <div class="surface-demo" id="surfaces-demo"></div>

    <!-- ── Brand / Background Tokens ──────────────────────── -->
    <div class="section-card">
    <span class="chroma-title" style="display:block;margin-bottom:0.75rem">Primitive Tokens</span>
    <div class="tab-group" id="primitiveTabGroup" style="margin-bottom:2rem">
      <div class="tab-bar" id="primitiveTabBar">
        <button class="tab-btn active" data-tab="brand">Brand</button>
        <button class="tab-btn" data-tab="error">Error</button>
        <!-- accent top-level tabs injected here by JS (before neutral) -->
        <button class="tab-btn" data-tab="neutral">Neutral</button>
      </div>
      <!-- Brand: Vibrant + Surface sub-tabs -->
      <div class="tab-content active" data-tab="brand">
        <div class="sub-tab-bar">
          <button class="sub-tab-btn active" data-subtab="brand-color">Action</button>
          <button class="sub-tab-btn" data-subtab="brand-surface">Surface</button>
        </div>
        <div class="sub-tab-content active" data-subtab="brand-color">
          <p class="section-desc">Full chroma &mdash; buttons, switches, checkboxes, interactive elements</p>
          <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
            <tbody id="table-brand"></tbody>
          </table>
        </div>
        <div class="sub-tab-content" data-subtab="brand-surface">
          <p class="section-desc">Surfaces &middot; containers &mdash; <span id="chromaDescValue">25%</span> chroma<span id="bgColorNote"></span></p>
          <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
            <tbody id="table-bg"></tbody>
          </table>
        </div>
      </div>
      <!-- Error: Vibrant + Surface sub-tabs -->
      <div class="tab-content" data-tab="error">
        <div class="sub-tab-bar">
          <button class="sub-tab-btn active" data-subtab="error-color">Action</button>
          <button class="sub-tab-btn" data-subtab="error-surface">Surface</button>
        </div>
        <div class="sub-tab-content active" data-subtab="error-color">
          <p class="section-desc">Full chroma &mdash; destructive actions, alerts, validation states</p>
          <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
            <tbody id="table-error"></tbody>
          </table>
        </div>
        <div class="sub-tab-content" data-subtab="error-surface">
          <p class="section-desc">Error surface palette &mdash; <span id="errorSurfaceChromaVal">25%</span> chroma</p>
          <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
            <tbody id="table-error-surface"></tbody>
          </table>
        </div>
      </div>
      <!-- Neutral (no sub-tabs) -->
      <div class="tab-content" data-tab="neutral">
        <p class="section-desc">0% chroma &mdash; High Contrast surfaces &middot; #fff and #000 included</p>
        <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
          <tbody id="table-neutral"></tbody>
        </table>
      </div>
    </div>
    </div>

    <!-- ── Code blocks (always visible) ───────────────────── -->
    <div class="section-card">
    <h2 class="section-title">Export</h2>
    <p class="section-desc">Click the button in the top-right corner to copy the entire block</p>
    <div class="tab-group">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="oklch">Primitives OKLCH</button>
        <button class="tab-btn" data-tab="hex">Primitives Hex</button>
        <button class="tab-btn" data-tab="semantic">Semantic</button>
      </div>
      <div class="tab-content active" data-tab="oklch">
        <div class="code-block" id="code-oklch"><button class="copy-block-btn" onclick="copyBlock('code-oklch')">Copy</button></div>
      </div>
      <div class="tab-content" data-tab="hex">
        <div class="code-block" id="code-hex"><button class="copy-block-btn" onclick="copyBlock('code-hex')">Copy</button></div>
      </div>
      <div class="tab-content" data-tab="semantic">
        <div class="semantic-info">
          <span class="semantic-badge">Semantic Layer</span>
          <span class="semantic-note">References Primitive Tokens — paste after your :root block</span>
        </div>
        <div class="code-block code-block-semantic" id="code-semantic"><button class="copy-block-btn" onclick="copyBlock('code-semantic')">Copy</button></div>
      </div>
    </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ================================================================
    //  Utilities
    // ================================================================
    function debounce(fn, ms) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    // ================================================================
    //  OKLCH Color Math
    // ================================================================
    function srgbToLinear(c) {
      c /= 255;
      return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
    }
    function linearToSrgb(c) {
      c = Math.max(0, Math.min(1, c));
      return c <= 0.0031308 ? 12.92 * c : 1.055 * Math.pow(c, 1 / 2.4) - 0.055;
    }
    function linearSrgbToOklab(r, g, b) {
      let l_ = 0.4122214708*r + 0.5363325363*g + 0.0514459929*b;
      let m_ = 0.2119034982*r + 0.6806995451*g + 0.1073969566*b;
      let s_ = 0.0883024619*r + 0.2817188376*g + 0.6299787005*b;
      l_ = Math.cbrt(l_); m_ = Math.cbrt(m_); s_ = Math.cbrt(s_);
      return [
        0.2104542553*l_ + 0.7936177850*m_ - 0.0040720468*s_,
        1.9779984951*l_ - 2.4285922050*m_ + 0.4505937099*s_,
        0.0259040371*l_ + 0.7827717662*m_ - 0.8086757660*s_
      ];
    }
    function oklabToLinearSrgb(L, a, b) {
      let l_ = L + 0.3963377774*a + 0.2158037573*b;
      let m_ = L - 0.1055613458*a - 0.0638541728*b;
      let s_ = L - 0.0894841775*a - 1.2914855480*b;
      l_=l_*l_*l_; m_=m_*m_*m_; s_=s_*s_*s_;
      return [
        +4.0767416621*l_ - 3.3077115913*m_ + 0.2309699292*s_,
        -1.2684380046*l_ + 2.6097574011*m_ - 0.3413193965*s_,
        -0.0041960863*l_ - 0.7034186147*m_ + 1.7076147010*s_
      ];
    }
    function oklabToOklch(L, a, b) {
      return [L, Math.sqrt(a*a + b*b), ((Math.atan2(b, a) * 180 / Math.PI) % 360 + 360) % 360];
    }
    function oklchToOklab(L, C, H) {
      const rad = H * Math.PI / 180;
      return [L, C * Math.cos(rad), C * Math.sin(rad)];
    }
    function hexToRgb(hex) {
      hex = hex.replace('#','');
      return [parseInt(hex.substring(0,2),16), parseInt(hex.substring(2,4),16), parseInt(hex.substring(4,6),16)];
    }
    function rgbToHex(r, g, b) {
      const clamp = v => Math.max(0, Math.min(255, Math.round(v)));
      return '#' + [r,g,b].map(v => clamp(v).toString(16).padStart(2,'0').toUpperCase()).join('');
    }
    function hexToOklch(hex) {
      const [r,g,b] = hexToRgb(hex);
      const [lr,lg,lb] = [srgbToLinear(r), srgbToLinear(g), srgbToLinear(b)];
      const [L,a,b2] = linearSrgbToOklab(lr, lg, lb);
      return oklabToOklch(L, a, b2);
    }
    function oklchToHex(L, C, H) {
      const [_,a,b] = oklchToOklab(L, C, H);
      const [r,g,b2] = oklabToLinearSrgb(L, a, b);
      return rgbToHex(linearToSrgb(r)*255, linearToSrgb(g)*255, linearToSrgb(b2)*255);
    }
    function isInGamut(L, C, H) {
      const [_,a,b] = oklchToOklab(L, C, H);
      const [r,g,b2] = oklabToLinearSrgb(L, a, b);
      return r >= -0.001 && r <= 1.001 && g >= -0.001 && g <= 1.001 && b2 >= -0.001 && b2 <= 1.001;
    }
    function maxChromaInGamut(L, H) {
      if (L <= 0.001 || L >= 0.999) return 0;
      let lo = 0, hi = 0.4;
      while (hi - lo > 0.0005) {
        const mid = (lo + hi) / 2;
        if (isInGamut(L, mid, H)) lo = mid; else hi = mid;
      }
      return lo;
    }

    // ================================================================
    //  Palette Generation
    // ================================================================
    const STEPS = [25, 50, 75, 100, 200, 300, 400, 500, 600, 700, 800, 825, 850, 875, 900, 925, 950, 975];
    const L_WHITE = 0.98, L_BLACK = 0.10;

    let currentMode = 'balanced'; // 'balanced' or 'exact'
    let chromaScale = 0.25;      // background palette chroma (0–1)
    let bgColorHex = '#335A7F';  // default = initial primary
    let bgAutoMatch = true;
    let errorColorHex = '#CC3333'; // placeholder, overwritten on first generate if auto
    let errorAutoMatch = true;
    let extraAccents = []; // Array of { name: string, hex: string, pin: boolean } — max 3
    let brandPin = false;
    let errorPin = false;

    function computeAutoErrorHex(primaryHex) {
      const [pL, pC, pH] = hexToOklch(primaryHex);
      const ERROR_HUE = 25; // warm red
      const primaryMaxC = maxChromaInGamut(pL, pH);
      const saturation = primaryMaxC > 0.001 ? pC / primaryMaxC : 0.5;
      const errorMaxC = maxChromaInGamut(pL, ERROR_HUE);
      return oklchToHex(pL, errorMaxC * saturation * 0.95, ERROR_HUE);
    }

    function toggleBgAutoMatch() {
      bgAutoMatch = !bgAutoMatch;
      document.getElementById('bgAutoBtn').classList.toggle('active', bgAutoMatch);
      if (bgAutoMatch) generate();
    }

    function toggleErrorAutoMatch() {
      errorAutoMatch = !errorAutoMatch;
      document.getElementById('errorAutoBtn').classList.toggle('active', errorAutoMatch);
      if (errorAutoMatch) generate();
    }

    // ================================================================
    //  Accent Colors
    // ================================================================
    function accentCssName(name) {
      return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'accent';
    }

    function renderAccentInputs() {
      const container = document.getElementById('accentInputsContainer');
      const addBtn = document.getElementById('addAccentBtn');
      if (addBtn) addBtn.disabled = extraAccents.length >= 3;

      if (extraAccents.length === 0) {
        container.className = '';
        container.style.cssText = 'display:none';
        container.innerHTML = '';
        return;
      }

      container.className = 'color-pair-groups-row';
      container.style.cssText = '';

      container.innerHTML = extraAccents.map((a, i) => `
        <div class="color-pair-group">
          <div class="color-input-col">
            <div class="color-col-header">
              <input type="text" class="accent-name-input" id="accentName${i}" value="${a.name}" placeholder="Name" maxlength="20">
              <div style="display:flex;gap:0.25rem">
                <button class="auto-btn${a.pin ? ' active' : ''}" id="accentPin${i}" onclick="toggleAccentPin(${i})">Pin</button>
                <button class="accent-delete-btn" onclick="removeAccent(${i})">✕</button>
              </div>
            </div>
            <div class="color-input-wrapper">
              <div class="color-preview-swatch" id="accentSwatch${i}" style="background:${a.hex}" onclick="document.getElementById('accentPicker${i}').click()"></div>
              <input type="color" id="accentPicker${i}" value="${a.hex}" style="position:absolute;opacity:0;width:0;height:0">
              <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
              <input type="text" class="accent-hex-input" id="accentHex${i}" value="${a.hex.replace('#','')}" maxlength="6" spellcheck="false">
            </div>
          </div>
          <div class="color-input-col">
            <span class="color-col-label">Surface <span class="color-surface-auto">auto</span></span>
            <div class="color-input-wrapper">
              <div class="color-preview-swatch" id="accentSurfaceSwatch${i}" style="background:var(--bg-surface)"></div>
              <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
              <span id="accentSurfaceHex${i}" style="font-size:1.1rem;font-family:'Cascadia Code','Fira Code',monospace;color:var(--text-dim)">—</span>
            </div>
          </div>
        </div>`).join('');

      extraAccents.forEach((a, i) => {
        const picker  = document.getElementById('accentPicker' + i);
        const hexInp  = document.getElementById('accentHex' + i);
        const nameInp = document.getElementById('accentName' + i);
        const swatch  = document.getElementById('accentSwatch' + i);

        picker.addEventListener('input', e => {
          const hex = e.target.value.toUpperCase();
          extraAccents[i].hex = hex;
          hexInp.value = hex.replace('#', '');
          swatch.style.background = hex;
          generate();
        });
        hexInp.addEventListener('input', e => {
          const cleaned = e.target.value.replace(/#/g, '');
          if (cleaned !== e.target.value) e.target.value = cleaned;
          if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
            extraAccents[i].hex = '#' + cleaned.toUpperCase();
            swatch.style.background = extraAccents[i].hex;
            picker.value = extraAccents[i].hex;
            generate();
          }
        });
        hexInp.addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
        nameInp.addEventListener('input', e => {
          extraAccents[i].name = e.target.value || 'Accent ' + (i + 1);
          generate();
        });
      });
    }

    function toggleBrandPin() {
      brandPin = !brandPin;
      document.getElementById('brandPinBtn').classList.toggle('active', brandPin);
      generate();
    }
    function toggleErrorPin() {
      errorPin = !errorPin;
      document.getElementById('errorPinBtn').classList.toggle('active', errorPin);
      generate();
    }
    function toggleAccentPin(i) {
      extraAccents[i].pin = !extraAccents[i].pin;
      const btn = document.getElementById('accentPin' + i);
      if (btn) btn.classList.toggle('active', extraAccents[i].pin);
      generate();
    }

    function addAccent() {
      if (extraAccents.length >= 3) return;
      extraAccents.push({ name: 'Accent ' + (extraAccents.length + 1), hex: '#7C3AED', pin: false });
      renderAccentInputs();
      generate();
    }

    function removeAccent(index) {
      extraAccents.splice(index, 1);
      renderAccentInputs();
      generate();
    }

    function renderAccentTabs(accentPalettes) {
      const group  = document.getElementById('primitiveTabGroup');
      const tabBar = document.getElementById('primitiveTabBar');
      if (!group || !tabBar) return;
      // Remove existing dynamic accent tabs
      group.querySelectorAll('[data-tab^="accent-"]').forEach(el => el.remove());
      // Insert before Neutral (always last)
      const neutralBtn     = tabBar.querySelector('[data-tab="neutral"]');
      const neutralContent = group.querySelector('.tab-content[data-tab="neutral"]');
      const pct  = Math.round(chromaScale * 100);
      const thead = `<thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>`;

      accentPalettes.forEach((entry, i) => {
        const tabId = 'accent-' + i;

        const btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.dataset.tab = tabId;
        btn.textContent = entry.name;
        tabBar.insertBefore(btn, neutralBtn);

        const content = document.createElement('div');
        content.className = 'tab-content';
        content.dataset.tab = tabId;
        content.innerHTML = `
          <div class="sub-tab-bar">
            <button class="sub-tab-btn active" data-subtab="${tabId}-color">Action</button>
            <button class="sub-tab-btn" data-subtab="${tabId}-surface">Surface</button>
          </div>
          <div class="sub-tab-content active" data-subtab="${tabId}-color">
            <p class="section-desc">Full chroma &mdash; ${entry.name} accent scale</p>
            <table>${thead}<tbody id="table-accent-${i}"></tbody></table>
          </div>
          <div class="sub-tab-content" data-subtab="${tabId}-surface">
            <p class="section-desc">${entry.name} surface palette &mdash; ${pct}% chroma</p>
            <table>${thead}<tbody id="table-accent-surface-${i}"></tbody></table>
          </div>`;
        group.insertBefore(content, neutralContent);
        renderTable('table-accent-' + i, entry.palette);
        renderTable('table-accent-surface-' + i, entry.slatedPalette || entry.palette);
      });
    }

    function buildAccentBtns(accentPalettes, panelType) {
      if (!accentPalettes || accentPalettes.length === 0) return '';
      return accentPalettes.map(entry => {
        const a = {}; entry.palette.forEach(r => a[r.step] = r);
        const btnSwatch = (panelType === 'light' || panelType === 'light-hc') ? a[600] : a[400];
        const fg = btnSwatch.L < 0.55 ? '#fff' : '#111';
        return `<div class="surface-btn" style="background:${btnSwatch.hex};color:${fg}">${entry.name}</div>`;
      }).join('');
    }

    function buildAccentMiniCards(accentPalettes, panelType) {
      if (!accentPalettes || accentPalettes.length === 0) return '';
      return accentPalettes.map(entry => {
        const a = {}; entry.palette.forEach(r => a[r.step] = r);
        const as = {}; (entry.slatedPalette || entry.palette).forEach(r => as[r.step] = r);
        let bgColor, borderColor, textColor, dotColor;
        if (panelType === 'light')         { bgColor = as[100].hex; borderColor = as[300].hex; textColor = as[800].hex; dotColor = entry.pin ? entry.hex : a[600].hex; }
        else if (panelType === 'dark')     { bgColor = as[850].hex; borderColor = as[700].hex; textColor = as[100].hex; dotColor = entry.pin ? entry.hex : a[400].hex; }
        else if (panelType === 'light-hc') { bgColor = '#ffffff';   borderColor = as[200].hex; textColor = as[900].hex; dotColor = entry.pin ? entry.hex : a[700].hex; }
        else                               { bgColor = '#000000';   borderColor = as[800].hex; textColor = as[75].hex;  dotColor = entry.pin ? entry.hex : a[300].hex; }
        return `<div class="accent-mini-card" style="background:${bgColor};border-color:${borderColor};color:${textColor}">
          <div class="accent-mini-card-dot" style="background:${dotColor}"></div>
          ${entry.name}
        </div>`;
      }).join('');
    }

    function generatePalette(hex, chromaScale = 1.0) {
      const [bL, bC, bH] = hexToOklch(hex);

      const inputMaxC = maxChromaInGamut(bL, bH);
      const saturation = inputMaxC > 0.001 ? bC / inputMaxC : 0;
      const blend = Math.min(1, saturation / 0.3);
      const safeH = bC > 0.005 ? bH : 0;

      // ── Mode-dependent: determine L_MID for step 500 ──
      const L_MID = currentMode === 'exact' ? bL : 0.50;

      function stepToL(step) {
        if (step <= 500) return L_WHITE + (step / 500) * (L_MID - L_WHITE);
        return L_MID + ((step - 500) / 500) * (L_BLACK - L_MID);
      }

      // ── Mode-dependent: chroma strategy ──
      if (currentMode === 'exact') {
        return STEPS.map(step => {
          const L = stepToL(step);
          const H = safeH;
          let C;

          if (step === 500) {
            C = bC * chromaScale;
          } else {
            const stepNorm = step <= 500 ? step / 500 : (1000 - step) / 500;
            const envelope = 1 - Math.pow(1 - stepNorm, 2);
            const desired = bC * chromaScale * envelope;
            const gamutMax = bC > 0.005 ? maxChromaInGamut(L, safeH) : 0;
            C = Math.min(desired, gamutMax * 0.95);
          }

          const hx = oklchToHex(L, C, H);
          const css = `oklch(${L.toFixed(4)} ${C.toFixed(4)} ${H.toFixed(2)})`;
          return { step, L, C, H, hex: hx, css };
        });
      }

      // BALANCED MODE
      const maxC500 = maxChromaInGamut(L_MID, safeH);
      const targetC500 = maxC500 * 0.88 * blend;

      return STEPS.map(step => {
        const L = stepToL(step);
        const envelope = 1 - Math.pow(2 * L - 1, 2);
        const desired = targetC500 * chromaScale * Math.max(0, envelope);
        const gamutMax = bC > 0.005 ? maxChromaInGamut(L, safeH) : 0;
        const C = Math.min(desired, gamutMax * 0.95);
        const H = safeH;
        const hx = oklchToHex(L, C, H);
        const css = `oklch(${L.toFixed(4)} ${C.toFixed(4)} ${H.toFixed(2)})`;
        return { step, L, C, H, hex: hx, css };
      });
    }

    // ================================================================
    //  Rendering
    // ================================================================
    function getZone(step, showHC = false) {
      if (step === 0)    return showHC ? { label: 'HC White', cls: 'hc' } : null;
      if (step === 1000) return showHC ? { label: 'HC Black', cls: 'hc' } : null;
      if (step <= 100)   return { label: 'Light Surfaces', cls: 'light' };
      if (step >= 825 && step <= 875) return { label: 'Dark Surfaces', cls: 'dark' };
      if (step >= 900 && showHC) return { label: 'High Contrast', cls: 'hc' };
      return null;
    }

function renderTable(tbodyId, palette, showHC = false) {
      document.getElementById(tbodyId).innerHTML = palette.map(r => {
        const is500 = r.step === 500;
        const bg = is500 ? ' style="background:rgba(255,255,255,0.04)"' : '';
        const b = is500 ? s => `<strong>${s}</strong>` : s => s;
        const zone = getZone(r.step, showHC);
        const zt = zone ? `<span class="zone-tag ${zone.cls}">${zone.label}</span>` : '';
        const dotOutline = is500 ? ';outline:2px solid rgba(255,255,255,0.5)' : '';
        return `<tr${bg}>
          <td>${b(r.step)}</td>
          <td><div class="color-dot" style="background:${r.hex}${dotOutline}"></div></td>
          <td><span class="copyable" onclick="copyValue(this)" data-value="${r.hex}">${b(r.hex)}</span></td>
          <td><span class="copyable" onclick="copyValue(this)" data-value="${r.css}">${b(r.css)}</span></td>
          <td>${b(r.L.toFixed(3))}</td>
          <td>${b(r.C.toFixed(3))}</td>
          <td>${zt}</td>
        </tr>`;
      }).join('');
    }

    function buildPanelSvg(idx) {
      const fid = `svg-ps-${idx}`;
      return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:130px;display:block;margin:0.5rem 0 0.75rem;">
        <defs>
          <filter id="${fid}" x="-10%" y="-10%" width="120%" height="120%">
            <feDropShadow dx="2" dy="5" stdDeviation="4" flood-color="rgba(0,0,0,0.18)" flood-opacity="1"/>
          </filter>
        </defs>
        <circle cx="100" cy="100" r="75" fill="var(--svg-bg)"/>
        <g class="svg-anim-palette">
          <path d="M 60 135 C 50 95, 100 90, 130 100 C 150 105, 155 140, 135 155 C 110 170, 70 175, 60 135 Z" fill="var(--svg-srf-2)" filter="url(#${fid})"/>
          <path d="M 60 130 C 50 90, 100 85, 130 95 C 150 100, 155 135, 135 150 C 110 165, 70 170, 60 130 Z" fill="var(--svg-srf-1)"/>
          <circle cx="75" cy="137" r="9" fill="var(--svg-srf-2)"/>
          <circle cx="75" cy="135" r="9" fill="var(--svg-bg)"/>
          <ellipse cx="78" cy="115" rx="8" ry="5" fill="var(--svg-brand-1)" transform="rotate(-15 78 115)"/>
          <ellipse cx="98" cy="103" rx="8" ry="5.5" fill="var(--svg-brand-2)" transform="rotate(-5 98 103)"/>
          <ellipse cx="118" cy="104" rx="9" ry="6" fill="var(--svg-brand-3)" transform="rotate(10 118 104)"/>
          <ellipse cx="135" cy="120" rx="10" ry="6.5" fill="var(--svg-brand-4)" transform="rotate(30 135 120)"/>
        </g>
        <circle class="svg-anim-splash" cx="135" cy="120" r="10" fill="none" stroke="var(--svg-brand-4)" stroke-width="2"/>
        <circle class="svg-anim-splash" cx="135" cy="120" r="14" fill="none" stroke="var(--svg-brand-2)" stroke-width="1.5" style="animation-delay:0.1s"/>
        <g class="svg-anim-brush">
          <path d="M -4 -35 Q -8 -60 -3 -80 Q 0 -85 3 -80 Q 8 -60 4 -35 Z" fill="var(--svg-srf-3)"/>
          <path d="M 0 -35 Q -2 -60 0 -83 Q 6 -60 4 -35 Z" fill="var(--svg-srf-2)" opacity="0.4"/>
          <rect x="-5" y="-35" width="10" height="12" rx="1" fill="var(--svg-srf-2)"/>
          <line x1="-5" y1="-31" x2="5" y2="-31" stroke="var(--svg-srf-line)" stroke-width="1"/>
          <line x1="-5" y1="-27" x2="5" y2="-27" stroke="var(--svg-srf-line)" stroke-width="1"/>
          <path d="M -5 -23 C -10 -10 -5 -2 0 0 C 4 -2 8 -12 5 -23 Z" fill="var(--svg-bristle)"/>
          <path d="M -3.5 -12 C -5 -5 -2 -1 0 0 C 2 -1 5 -5 3.5 -12 Q 0 -9 -3.5 -12 Z" fill="var(--svg-brand-4)"/>
        </g>
      </svg>`;
    }

    function renderSurfaces(containerId, palette, slatedPalette, neutral, accentSwatch, brandPalette, accentPalettes, errorPalette, errorSlatedPalette, errorSwatchOverride) {
      accentPalettes = accentPalettes || [];
      const s = {}; palette.forEach(r => s[r.step] = r);
      const n = {}; neutral.forEach(r => n[r.step] = r);
      const v = {}; brandPalette.forEach(r => v[r.step] = r);
      const e = {}; errorPalette.forEach(r => e[r.step] = r);
      const es = {}; errorSlatedPalette.forEach(r => es[r.step] = r);
      const btnBg  = accentSwatch.hex;
      const btnFg  = accentSwatch.L < 0.55 ? '#fff' : '#111';
      const errSwatch = errorSwatchOverride || e[500];
      const errBg  = errSwatch.hex;
      const errFg  = errSwatch.L < 0.55 ? '#fff' : '#111';
      const textLight = s[850].hex;
      const textDark  = s[75].hex;
      const makeBtns = () => `<div class="surface-btns">
          <div class="surface-btn" style="background:${btnBg};color:${btnFg}">Primary</div>
          <div class="surface-btn" style="background:${errBg};color:${errFg}">Error</div>
        </div>`;
      const buildErrorMiniCard = (panelType) => {
        let bgColor, borderColor, textColor, dotColor;
        if (panelType === 'light')         { bgColor = es[100].hex; borderColor = es[300].hex; textColor = es[800].hex; dotColor = e[600].hex; }
        else if (panelType === 'dark')     { bgColor = es[850].hex; borderColor = es[700].hex; textColor = es[100].hex; dotColor = e[400].hex; }
        else if (panelType === 'light-hc') { bgColor = '#ffffff';   borderColor = es[200].hex; textColor = es[900].hex; dotColor = e[700].hex; }
        else                               { bgColor = '#000000';   borderColor = es[800].hex; textColor = es[75].hex;  dotColor = e[300].hex; }
        return `<div class="accent-mini-card" style="background:${bgColor};border-color:${borderColor};color:${textColor}">
          <div class="accent-mini-card-dot" style="background:${dotColor}"></div>Error
        </div>`;
      };

      const lightVars = `--svg-bg:${s[200].hex};--svg-srf-1:${s[75].hex};--svg-srf-2:${s[300].hex};--svg-srf-3:${s[200].hex};--svg-srf-line:${s[400].hex};--svg-bristle:#fdfcfb;--svg-brand-1:${v[300].hex};--svg-brand-2:${v[400].hex};--svg-brand-3:${v[500].hex};--svg-brand-4:${v[600].hex}`;
      const darkVars  = `--svg-bg:${s[700].hex};--svg-srf-1:${s[500].hex};--svg-srf-2:${s[600].hex};--svg-srf-3:${s[500].hex};--svg-srf-line:${s[400].hex};--svg-bristle:#fdfcfb;--svg-brand-1:${v[300].hex};--svg-brand-2:${v[400].hex};--svg-brand-3:${v[500].hex};--svg-brand-4:${v[600].hex}`;
      const lhcVars   = `--svg-bg:${n[200].hex};--svg-srf-1:#ffffff;--svg-srf-2:${n[400].hex};--svg-srf-3:${n[300].hex};--svg-srf-line:${n[500].hex};--svg-bristle:#fdfcfb;--svg-brand-1:${v[400].hex};--svg-brand-2:${v[500].hex};--svg-brand-3:${v[600].hex};--svg-brand-4:${v[700].hex}`;
      const dhcVars   = `--svg-bg:${n[700].hex};--svg-srf-1:${n[500].hex};--svg-srf-2:${n[600].hex};--svg-srf-3:${n[500].hex};--svg-srf-line:${n[400].hex};--svg-bristle:#fdfcfb;--svg-brand-1:${v[200].hex};--svg-brand-2:${v[300].hex};--svg-brand-3:${v[400].hex};--svg-brand-4:${v[500].hex}`;

      document.getElementById(containerId).innerHTML = `
        <div class="surface-panel" style="background:${s[100].hex};color:${textLight};${lightVars}">
          <div class="mode-tag">Light</div><h3>Surfaces (25&ndash;100)</h3>
          ${buildPanelSvg(0)}
          <div class="surface-card" style="background:${s[25].hex}"><p><strong>Card (25)</strong> on BG (100)</p></div>
          <div class="surface-card" style="background:${s[50].hex}"><p><strong>Elevated (50)</strong> on BG (100)</p></div>
          <div class="surface-card" style="background:${s[75].hex}"><p><strong>Active (75)</strong> on BG (100)</p></div>
          ${makeBtns()}
          ${buildErrorMiniCard('light')}
          ${buildAccentMiniCards(accentPalettes, 'light')}
        </div>
        <div class="surface-panel" style="background:${s[875].hex};color:${textDark};${darkVars}">
          <div class="mode-tag">Dark</div><h3>Surfaces (800&ndash;875)</h3>
          ${buildPanelSvg(1)}
          <div class="surface-card" style="background:${s[800].hex}"><p><strong>Card (800)</strong> on BG (875)</p></div>
          <div class="surface-card" style="background:${s[825].hex}"><p><strong>Elevated (825)</strong> on BG (875)</p></div>
          <div class="surface-card" style="background:${s[850].hex}"><p><strong>Active (850)</strong> on BG (875)</p></div>
          ${makeBtns()}
          ${buildErrorMiniCard('dark')}
          ${buildAccentMiniCards(accentPalettes, 'dark')}
        </div>
        <div class="surface-panel" style="background:${n[75].hex};color:#000000;${lhcVars}">
          <div class="mode-tag">Light &middot; High Contrast</div><h3>Neutral Surfaces</h3>
          ${buildPanelSvg(2)}
          <div class="surface-card" style="background:#ffffff"><p><strong>Card (#fff)</strong> on BG (n75)</p></div>
          <div class="surface-card" style="background:${n[25].hex}"><p><strong>Elevated (n25)</strong> on BG (n75)</p></div>
          <div class="surface-card" style="background:${n[50].hex}"><p><strong>Active (n50)</strong> on BG (n75)</p></div>
          ${makeBtns()}
          ${buildErrorMiniCard('light-hc')}
          ${buildAccentMiniCards(accentPalettes, 'light-hc')}
        </div>
        <div class="surface-panel" style="background:#000000;color:#ffffff;${dhcVars}">
          <div class="mode-tag">Dark &middot; High Contrast</div><h3>Neutral Surfaces</h3>
          ${buildPanelSvg(3)}
          <div class="surface-card" style="background:${n[975].hex}"><p><strong>Card (n975)</strong> on BG (#000)</p></div>
          <div class="surface-card" style="background:${n[950].hex}"><p><strong>Elevated (n950)</strong> on BG (#000)</p></div>
          <div class="surface-card" style="background:${n[925].hex}"><p><strong>Active (n925)</strong> on BG (#000)</p></div>
          ${makeBtns()}
          ${buildErrorMiniCard('dark-hc')}
          ${buildAccentMiniCards(accentPalettes, 'dark-hc')}
        </div>`;
    }

    function renderCodeBlocks(brand, bg, error, errorSlated, neutral, customBgHex = null, accentPalettes = []) {
      const pct = Math.round(chromaScale * 100);
      const bgLabel = customBgHex ? `${pct}% chroma — base ${customBgHex}` : `${pct}% chroma`;
      const neutralExt = [
        { step: 0,    L: 1, C: 0, H: 0, hex: '#FFFFFF', css: 'oklch(1 0 0)' },
        ...neutral,
        { step: 1000, L: 0, C: 0, H: 0, hex: '#000000', css: 'oklch(0 0 0)' }
      ];

      const cmt = t => `\n  <span class="cmt">/* ${t} */</span>\n`;

      // ── Primitives OKLCH ──
      const oklchBlock = document.getElementById('code-oklch');
      const btn1 = oklchBlock.querySelector('.copy-block-btn').outerHTML;
      let o = `<span class="cmt">/* Primitive Tokens */</span>\n:root {\n`;
      o += cmt('Brand') + fmtSec(brand, 'brand', 'css');
      o += cmt(`Surface — ${bgLabel}`) + fmtSec(bg, 'surface', 'css');
      o += cmt('Error') + fmtSec(error, 'error', 'css');
      o += cmt(`Error Surface — ${pct}% chroma`) + fmtSec(errorSlated, 'error-surface', 'css');
      o += cmt('Neutral') + fmtSec(neutralExt, 'neutral', 'css');
      accentPalettes.forEach(entry => {
        o += cmt(entry.name) + fmtSec(entry.palette, entry.cssName, 'css');
        o += cmt(`${entry.name} Surface — ${pct}% chroma`) + fmtSec(entry.slatedPalette, entry.cssName + '-surface', 'css');
      });
      o += `}`; oklchBlock.innerHTML = btn1 + o;

      // ── Primitives Hex ──
      const hexBlock = document.getElementById('code-hex');
      const btn2 = hexBlock.querySelector('.copy-block-btn').outerHTML;
      let h = `<span class="cmt">/* Primitive Tokens (Hex) */</span>\n:root {\n`;
      h += cmt('Brand') + fmtSec(brand, 'brand', 'hex');
      h += cmt(`Surface — ${bgLabel}`) + fmtSec(bg, 'surface', 'hex');
      h += cmt('Error') + fmtSec(error, 'error', 'hex');
      h += cmt(`Error Surface — ${pct}% chroma`) + fmtSec(errorSlated, 'error-surface', 'hex');
      h += cmt('Neutral') + fmtSec(neutralExt, 'neutral', 'hex');
      accentPalettes.forEach(entry => {
        h += cmt(entry.name) + fmtSec(entry.palette, entry.cssName, 'hex');
        h += cmt(`${entry.name} Surface — ${pct}% chroma`) + fmtSec(entry.slatedPalette, entry.cssName + '-surface', 'hex');
      });
      h += `}`; hexBlock.innerHTML = btn2 + h;

      // ── Semantic ──
      const semBlock = document.getElementById('code-semantic');
      const btn3 = semBlock.querySelector('.copy-block-btn').outerHTML;
      semBlock.innerHTML = btn3 + renderSemantic(accentPalettes);
    }

    function renderSemantic(accentPalettes = []) {
      const prop = name => `  <span class="prop">--${name}</span>`;
      const ref  = (prefix, step) => `<span class="val">var(--color-${prefix}-${step})</span>`;
      const line = (name, prefix, step) => `${prop(name)}: ${ref(prefix, step)};\n`;
      const cmt  = t => `  <span class="cmt">/* ${t} */</span>\n`;

      const block = (sel, rows) => {
        let o = `${sel} {\n`;
        rows.forEach(([name, prefix, step]) => {
          o += prefix === null ? cmt(step) : line(name, prefix, step);
        });
        return o + `}\n`;
      };

      const root = block(':root', [
        [null,    null,             'Base'],
        ['background',              'surface', 50],
        ['foreground',              'surface', 975],
        [null,    null,             'Card'],
        ['card',                    'surface', 25],
        ['card-foreground',         'surface', 975],
        [null,    null,             'Popover'],
        ['popover',                 'surface', 25],
        ['popover-foreground',      'surface', 975],
        [null,    null,             'Primary'],
        ['primary',                 'brand',   600],
        ['primary-foreground',      'brand',   50],
        [null,    null,             'Secondary — softened brand'],
        ['secondary',               'brand',   200],
        ['secondary-foreground',    'brand',   900],
        [null,    null,             'Muted'],
        ['muted',                   'surface', 75],
        ['muted-foreground',        'surface', 700],
        [null,    null,             'Accent'],
        ['accent',                  'brand',   100],
        ['accent-foreground',       'brand',   950],
        [null,    null,             'Destructive'],
        ['destructive',             'error',   600],
        ['destructive-foreground',  'error-surface', 100],
        [null,    null,             'Border / Input / Ring'],
        ['border',                  'surface', 400],
        ['input',                   'surface', 300],
        ['ring',                    'surface', 400],
        [null,    null,             'Sidebar'],
        ['sidebar',                      'surface', 25],
        ['sidebar-foreground',           'surface', 975],
        ['sidebar-primary',              'brand',   600],
        ['sidebar-primary-foreground',   'brand',   50],
        ['sidebar-accent',               'brand',   100],
        ['sidebar-accent-foreground',    'brand',   950],
        ['sidebar-border',               'surface', 400],
        ['sidebar-ring',                 'surface', 400],
      ]);

      const dark = block('.dark', [
        [null,    null,             'Base'],
        ['background',              'surface', 850],
        ['foreground',              'surface', 25],
        [null,    null,             'Card'],
        ['card',                    'surface', 875],
        ['card-foreground',         'surface', 25],
        [null,    null,             'Popover'],
        ['popover',                 'surface', 875],
        ['popover-foreground',      'surface', 25],
        [null,    null,             'Primary'],
        ['primary',                 'brand',   400],
        ['primary-foreground',      'brand',   975],
        [null,    null,             'Secondary — softened brand'],
        ['secondary',               'brand',   800],
        ['secondary-foreground',    'brand',   100],
        [null,    null,             'Muted'],
        ['muted',                   'surface', 825],
        ['muted-foreground',        'surface', 300],
        [null,    null,             'Accent'],
        ['accent',                  'brand',   800],
        ['accent-foreground',       'brand',   50],
        [null,    null,             'Destructive'],
        ['destructive',             'error',   400],
        ['destructive-foreground',  'error-surface', 900],
        [null,    null,             'Border / Input / Ring'],
        ['border',                  'surface', 600],
        ['input',                   'surface', 700],
        ['ring',                    'surface', 600],
        [null,    null,             'Sidebar'],
        ['sidebar',                      'surface', 875],
        ['sidebar-foreground',           'surface', 25],
        ['sidebar-primary',              'brand',   400],
        ['sidebar-primary-foreground',   'brand',   975],
        ['sidebar-accent',               'brand',   800],
        ['sidebar-accent-foreground',    'brand',   50],
        ['sidebar-border',               'surface', 600],
        ['sidebar-ring',                 'surface', 600],
      ]);

      let accentBlocks = '';
      accentPalettes.forEach(entry => {
        const n = entry.cssName;
        const accentRoot = block(`:root`, [
          [null,                           null, `${entry.name} — light`],
          [`${n}`,                         n, 600],
          [`${n}-foreground`,              n, 50],
          [null,                           null, 'Secondary'],
          [`${n}-secondary`,               n, 200],
          [`${n}-secondary-foreground`,    n, 900],
          [null,                           null, 'Muted / Subtle'],
          [`${n}-muted`,                   `${n}-surface`, 75],
          [`${n}-muted-foreground`,        `${n}-surface`, 700],
          [`${n}-subtle`,                  n, 100],
          [`${n}-subtle-foreground`,       n, 950],
          [null,                           null, 'Border / Input / Ring'],
          [`${n}-border`,                  `${n}-surface`, 300],
          [`${n}-input`,                   `${n}-surface`, 300],
          [`${n}-ring`,                    `${n}-surface`, 400],
        ]);
        const accentDark = block(`.dark`, [
          [null,                           null, `${entry.name} — dark`],
          [`${n}`,                         n, 400],
          [`${n}-foreground`,              n, 975],
          [null,                           null, 'Secondary'],
          [`${n}-secondary`,               n, 800],
          [`${n}-secondary-foreground`,    n, 100],
          [null,                           null, 'Muted / Subtle'],
          [`${n}-muted`,                   `${n}-surface`, 825],
          [`${n}-muted-foreground`,        `${n}-surface`, 300],
          [`${n}-subtle`,                  n, 800],
          [`${n}-subtle-foreground`,       n, 50],
          [null,                           null, 'Border / Input / Ring'],
          [`${n}-border`,                  `${n}-surface`, 700],
          [`${n}-input`,                   `${n}-surface`, 700],
          [`${n}-ring`,                    `${n}-surface`, 600],
        ]);
        accentBlocks += `\n<span class="cmt">/* ${entry.name} Accent — semantic tokens */</span>\n` + accentRoot + '\n' + accentDark;
      });

      return `<span class="cmt">/* Semantic Tokens — shadcn/ui compatible */</span>\n` + root + '\n' + dark + accentBlocks;
    }

    function fmtSec(palette, prefix, mode) {
      const gs = [
        { l: 'Light Surfaces', f: r => r.step <= 100 },
        { l: 'Core', f: r => r.step >= 200 && r.step <= 800 },
        { l: 'Dark Surfaces (normal)', f: r => r.step >= 825 && r.step <= 875 },
        { l: 'Dark Surfaces (high contrast)', f: r => r.step >= 900 },
      ];
      let out = '';
      gs.forEach((g, i) => {
        if (i > 0) out += '\n';
        out += `  <span class="cmt">/* ${g.l} */</span>\n`;
        palette.filter(g.f).forEach(r => {
          const v = mode === 'css' ? r.css : r.hex;
          out += `  <span class="prop">--color-${prefix}-${r.step}</span>: <span class="val">${v}</span>;\n`;
        });
      });
      return out;
    }

    // ================================================================
    //  Theme update — Dark HC palette drives page chrome
    // ================================================================
    function updateTheme(vibrant, slated, neutral) {
      const v  = {}; vibrant.forEach(r => v[r.step]  = r);
      const sl = {}; slated.forEach(r  => sl[r.step] = r);
      const n  = {}; neutral.forEach(r => n[r.step]  = r);
      const root = document.documentElement;

      root.style.setProperty('--bg-page',     n[975].hex);
      root.style.setProperty('--bg-surface',  n[950].hex);
      root.style.setProperty('--bg-code',     n[975].hex);
      root.style.setProperty('--border',      n[900].hex);
      root.style.setProperty('--border-sub',  n[925].hex);
      root.style.setProperty('--border-hi',   n[800].hex);
      root.style.setProperty('--toast-bg',    n[900].hex);

      root.style.setProperty('--text-hi',     sl[75].hex);
      root.style.setProperty('--text-mid',    sl[200].hex);
      root.style.setProperty('--text-low',    sl[300].hex);
      root.style.setProperty('--text-dim',    sl[400].hex);
      root.style.setProperty('--text-faint',  sl[500].hex);
      root.style.setProperty('--text-info',   sl[200].hex);

      root.style.setProperty('--accent',      v[500].hex);
      root.style.setProperty('--accent-bg',   v[800].hex);
      root.style.setProperty('--accent-text', v[300].hex);

      const h = v[500].hex.replace('#', '');
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      root.style.setProperty('--focus-ring', `rgba(${r},${g},${b},0.2)`);
    }

    // ================================================================
    //  Mode switch
    // ================================================================
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-option').forEach(b => {
        b.classList.toggle('active', b.dataset.mode === mode);
      });
      document.getElementById('modeHint').innerHTML = mode === 'balanced'
        ? '500 = perceptual midpoint (L=0.50) &mdash; palette is symmetric around the brightest point of the hue'
        : '500 = exactly your input color &mdash; lightness + chroma are scaled evenly around it';
      generate();
    }

    // ================================================================
    //  Main
    // ================================================================
    function generate() {
      const raw = document.getElementById('hexInput').value.replace(/#/g,'').trim();
      if (!/^[0-9a-fA-F]{6}$/.test(raw)) {
        showToast('Please enter a valid 6-digit hex code');
        return;
      }
      const hex = '#' + raw.toUpperCase();
      const [bL, bC, bH] = hexToOklch(hex);

      document.getElementById('swatchPreview').style.background = hex;
      document.getElementById('colorPicker').value = hex;

      // Surface auto-match: mirror primary
      if (bgAutoMatch) {
        bgColorHex = hex;
        document.getElementById('bgHexInput').value = raw.toUpperCase();
        document.getElementById('bgSwatchPreview').style.background = hex;
        document.getElementById('bgColorPicker').value = hex;
      }

      document.getElementById('bgColorNote').textContent =
        bgColorHex.toLowerCase() !== hex.toLowerCase() ? ` · ${bgColorHex}` : '';

      // Error color (auto-match if enabled)
      if (errorAutoMatch) {
        errorColorHex = computeAutoErrorHex(hex);
        document.getElementById('errorHexInput').value = errorColorHex.replace('#', '');
        document.getElementById('errorSwatchPreview').style.background = errorColorHex;
        document.getElementById('errorColorPicker').value = errorColorHex;
      }

      const brand        = generatePalette(hex, 1.0);
      const bg           = generatePalette(bgColorHex, chromaScale);
      const error        = generatePalette(errorColorHex, 1.0);
      const errorSlated  = generatePalette(errorColorHex, chromaScale);
      const neutral      = generatePalette(bgColorHex, 0.0);
      const slated       = generatePalette(bgColorHex, 0.5);

      const accentPalettes = extraAccents
        .map(a => /^#[0-9a-fA-F]{6}$/.test(a.hex)
          ? { name: a.name, hex: a.hex, cssName: accentCssName(a.name),
              palette: generatePalette(a.hex, 1.0),
              slatedPalette: generatePalette(a.hex, chromaScale),
              pin: !!a.pin }
          : null)
        .filter(Boolean);

      const c500brand   = brand.find(r => r.step === 500);
      const c500neutral = neutral.find(r => r.step === 500);

      // Pin overrides: use exact input hex when "Pin" is active
      const brandSwatch = brandPin
        ? { hex, L: hexToOklch(hex)[0] }
        : c500brand;
      const errorSwatchOverride = errorPin
        ? { hex: errorColorHex, L: hexToOklch(errorColorHex)[0] }
        : null;
      document.getElementById('chromaSlider').style.background =
        `linear-gradient(to right, ${c500neutral.hex}, ${c500brand.hex})`;
      const neutralExtended = [
        { step: 0,    L: 1, C: 0, H: 0, hex: '#FFFFFF', css: 'oklch(1 0 0)' },
        ...neutral,
        { step: 1000, L: 0, C: 0, H: 0, hex: '#000000', css: 'oklch(0 0 0)' }
      ];

      // Update surface preview swatches (auto-derived, read-only)
      const esSwatch = errorSlated.find(r => r.step === 200);
      if (esSwatch) {
        const el = document.getElementById('errorSurfacePreview');
        if (el) el.style.background = esSwatch.hex;
        const hx = document.getElementById('errorSurfaceHex');
        if (hx) hx.textContent = esSwatch.hex.replace('#', '');
      }

      updateTheme(brand, slated, neutral);
      renderTable('table-brand', brand);
      renderTable('table-bg', bg);
      renderTable('table-error', error);
      renderTable('table-error-surface', errorSlated);
      renderTable('table-neutral', neutralExtended, true);
      renderAccentTabs(accentPalettes);
      // Update accent surface preview swatches
      accentPalettes.forEach((entry, i) => {
        const s = entry.slatedPalette.find(r => r.step === 200);
        if (s) {
          const sw = document.getElementById('accentSurfaceSwatch' + i);
          if (sw) sw.style.background = s.hex;
          const hx = document.getElementById('accentSurfaceHex' + i);
          if (hx) hx.textContent = s.hex.replace('#', '');
        }
      });
      renderSurfaces('surfaces-demo', bg, slated, neutral, brandSwatch, brand, accentPalettes, error, errorSlated, errorSwatchOverride);
      renderCodeBlocks(brand, bg, error, errorSlated, neutral, bgColorHex.toLowerCase() !== hex.toLowerCase() ? bgColorHex : null, accentPalettes);
      document.getElementById('output').classList.add('visible');
      history.replaceState(null, '', '#' + encodeState());
      document.getElementById('favicon').href =
        `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="8" fill="${hex}"/></svg>`)}`;
    }

    // ================================================================
    //  Events
    // ================================================================
    document.getElementById('colorPicker').addEventListener('input', e => {
      document.getElementById('hexInput').value = e.target.value.replace('#','').toUpperCase();
      document.getElementById('swatchPreview').style.background = e.target.value;
      generate();
    });
    document.getElementById('hexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('hexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        document.getElementById('swatchPreview').style.background = '#' + cleaned;
        document.getElementById('colorPicker').value = '#' + cleaned;
        generate();
      }
    });

    // Surface color inputs
    document.getElementById('bgColorPicker').addEventListener('input', e => {
      bgAutoMatch = false;
      document.getElementById('bgAutoBtn').classList.remove('active');
      bgColorHex = e.target.value.toUpperCase();
      document.getElementById('bgHexInput').value = bgColorHex.replace('#', '');
      document.getElementById('bgSwatchPreview').style.background = bgColorHex;
      generate();
    });
    document.getElementById('bgHexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('bgHexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        bgAutoMatch = false;
        document.getElementById('bgAutoBtn').classList.remove('active');
        bgColorHex = '#' + cleaned.toUpperCase();
        document.getElementById('bgSwatchPreview').style.background = bgColorHex;
        document.getElementById('bgColorPicker').value = bgColorHex;
        generate();
      }
    });

    // Error color inputs
    document.getElementById('errorColorPicker').addEventListener('input', e => {
      errorAutoMatch = false;
      document.getElementById('errorAutoBtn').classList.remove('active');
      errorColorHex = e.target.value.toUpperCase();
      document.getElementById('errorHexInput').value = errorColorHex.replace('#', '');
      document.getElementById('errorSwatchPreview').style.background = errorColorHex;
      generate();
    });
    document.getElementById('errorHexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('errorHexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        errorAutoMatch = false;
        document.getElementById('errorAutoBtn').classList.remove('active');
        errorColorHex = '#' + cleaned.toUpperCase();
        document.getElementById('errorSwatchPreview').style.background = errorColorHex;
        document.getElementById('errorColorPicker').value = errorColorHex;
        generate();
      }
    });

    // Chroma slider
    const debouncedGenerate = debounce(generate, 80);
    document.getElementById('chromaSlider').addEventListener('input', e => {
      chromaScale = e.target.value / 100;
      document.getElementById('chromaInput').value = e.target.value + '%';
      document.getElementById('chromaDescValue').textContent = e.target.value + '%';
      document.getElementById('errorSurfaceChromaVal').textContent = e.target.value + '%';
      debouncedGenerate();
    });
    document.getElementById('chromaInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') e.target.blur();
    });
    document.getElementById('chromaInput').addEventListener('change', e => {
      const val = Math.round(Math.min(100, Math.max(0, parseFloat(e.target.value) || 0)));
      chromaScale = val / 100;
      document.getElementById('chromaSlider').value = val;
      e.target.value = val + '%';
      document.getElementById('chromaDescValue').textContent = val + '%';
      document.getElementById('errorSurfaceChromaVal').textContent = val + '%';
      generate();
    });

    // Tabs — delegated, handles both top-level and nested sub-tabs
    document.addEventListener('click', e => {
      // Sub-tabs (checked first — more specific selector)
      const subBtn = e.target.closest('.sub-tab-btn');
      if (subBtn) {
        const panel = subBtn.closest('.tab-content');
        if (!panel) return;
        panel.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        subBtn.classList.add('active');
        const subtab = subBtn.dataset.subtab;
        panel.querySelectorAll('.sub-tab-content').forEach(c =>
          c.classList.toggle('active', c.dataset.subtab === subtab));
        return;
      }
      // Top-level tabs
      const btn = e.target.closest('.tab-btn');
      if (!btn) return;
      const group = btn.closest('.tab-group');
      if (!group) return;
      group.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      group.querySelectorAll(':scope > .tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const target = group.querySelector(`:scope > .tab-content[data-tab="${btn.dataset.tab}"]`);
      if (target) target.classList.add('active');
    });

    // ================================================================
    //  URL State (share link)
    // ================================================================
    function encodeState() {
      const brand = document.getElementById('hexInput').value.replace(/#/g,'').trim();
      const bg    = bgColorHex.replace('#','');
      const err   = errorColorHex.replace('#','');
      const chroma = Math.round(chromaScale * 100);
      let hash = `${brand},${bg},${bgAutoMatch?1:0},${err},${errorAutoMatch?1:0},${chroma},${currentMode},${brandPin?1:0},${errorPin?1:0}`;
      extraAccents.forEach(a => {
        hash += `!${encodeURIComponent(a.name)}:${a.hex.replace('#','')}:${a.pin?1:0}`;
      });
      return hash;
    }

    function applyStateFromHash() {
      const hash = window.location.hash.slice(1);
      if (!hash) return;
      const segments = hash.split('!');
      const p = segments[0].split(',');
      if (p.length < 7) return;
      const [brand, bg, bgAuto, err, errAuto, chroma, mode] = p;
      if (/^[0-9a-fA-F]{6}$/.test(brand)) {
        document.getElementById('hexInput').value = brand.toUpperCase();
        document.getElementById('colorPicker').value = '#' + brand;
        document.getElementById('swatchPreview').style.background = '#' + brand;
      }
      bgAutoMatch = bgAuto === '1';
      document.getElementById('bgAutoBtn').classList.toggle('active', bgAutoMatch);
      if (/^[0-9a-fA-F]{6}$/.test(bg)) {
        bgColorHex = '#' + bg.toUpperCase();
        document.getElementById('bgHexInput').value = bg.toUpperCase();
        document.getElementById('bgColorPicker').value = '#' + bg;
        document.getElementById('bgSwatchPreview').style.background = '#' + bg;
      }
      errorAutoMatch = errAuto === '1';
      document.getElementById('errorAutoBtn').classList.toggle('active', errorAutoMatch);
      if (/^[0-9a-fA-F]{6}$/.test(err)) {
        errorColorHex = '#' + err.toUpperCase();
        document.getElementById('errorHexInput').value = err.toUpperCase();
        document.getElementById('errorColorPicker').value = '#' + err;
        document.getElementById('errorSwatchPreview').style.background = '#' + err;
      }
      const chromaVal = parseInt(chroma);
      if (!isNaN(chromaVal) && chromaVal >= 0 && chromaVal <= 100) {
        chromaScale = chromaVal / 100;
        document.getElementById('chromaSlider').value = chromaVal;
        document.getElementById('chromaInput').value = chromaVal + '%';
      }
      if (mode === 'balanced' || mode === 'exact') {
        currentMode = mode;
        document.querySelectorAll('.mode-option').forEach(btn =>
          btn.classList.toggle('active', btn.dataset.mode === mode));
      }
      // Restore brandPin / errorPin (parts 8 & 9, default false for old URLs)
      brandPin = p[7] === '1';
      errorPin = p[8] === '1';
      document.getElementById('brandPinBtn')?.classList.toggle('active', brandPin);
      document.getElementById('errorPinBtn')?.classList.toggle('active', errorPin);

      // Restore extra accents from !name:hex[:pin] segments
      extraAccents = [];
      for (let i = 1; i < segments.length; i++) {
        const firstColon = segments[i].indexOf(':');
        if (firstColon === -1) continue;
        const rawName = segments[i].substring(0, firstColon);
        const rest    = segments[i].substring(firstColon + 1);
        const restParts = rest.split(':');
        const rawHex  = restParts[0];
        const pin     = restParts[1] === '1';
        const name = decodeURIComponent(rawName) || ('Accent ' + i);
        if (/^[0-9a-fA-F]{6}$/.test(rawHex)) {
          extraAccents.push({ name, hex: '#' + rawHex.toUpperCase(), pin });
        }
      }
      renderAccentInputs();
    }

    function copyShareLink() {
      const url = window.location.href;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(() => showToast('Share link copied!'));
      } else {
        const el = document.createElement('textarea');
        el.value = url;
        el.style.cssText = 'position:fixed;top:-9999px;left:-9999px';
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        showToast('Share link copied!');
      }
    }

    function copyToClipboard(text, onSuccess) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(onSuccess);
      } else {
        const el = document.createElement('textarea');
        el.value = text;
        el.style.cssText = 'position:fixed;top:-9999px;left:-9999px';
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        onSuccess();
      }
    }
    function copyValue(el) {
      copyToClipboard(el.dataset.value, () => {
        showToast('Copied: ' + el.dataset.value);
        el.classList.add('copied');
        setTimeout(() => el.classList.remove('copied'), 1200);
      });
    }
    function copyBlock(id) {
      const block = document.getElementById(id);
      const text = block.innerText.replace(/^Copy\n?/, '').trim();
      const btn = block.querySelector('.copy-block-btn');
      copyToClipboard(text, () => {
        showToast('Block copied!');
        btn.textContent = 'Copied!'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
      });
    }
    let toastTimer;
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('show'), 2000);
    }

    applyStateFromHash();
    generate();
  </script>
</body>
</html>
