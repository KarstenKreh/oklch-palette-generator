<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKLCH Tonal Palette Generator</title>
  <style>
    :root {
      --bg-page:     #0e0e14;
      --bg-surface:  #16162a;
      --bg-code:     #0a0a12;
      --border:      #2a2a3a;
      --border-sub:  #18182a;
      --text-hi:     #e0e0e0;
      --text-mid:    #aaa;
      --text-low:    #777;
      --text-dim:    #666;
      --text-faint:  #555;
      --text-info:   #999;
      --accent:      #4a7aaa;
      --accent-bg:   #2a4a6a;
      --accent-text: #8cb4ff;
      --focus-ring:  rgba(74,122,170,0.15);
      --toast-bg:    #222;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-page); color: var(--text-hi);
      padding: 2.5rem 3rem; min-height: 100vh;
      transition: background-color 0.35s ease, color 0.35s ease;
    }
    h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.3rem; color: #fff; }
    .subtitle { font-size: 0.85rem; color: var(--text-low); margin-bottom: 2rem; line-height: 1.5; }

    /* ── Controls row ─────────────────────────────────────── */
    .controls-row {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
    }
    .controls-left  { display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0; align-items: flex-start; }
    .controls-right { display: flex; flex-direction: column; gap: 0.6rem; align-items: flex-start; margin-bottom: 2rem; }

    /* ── Input area ───────────────────────────────────────── */
    .color-input-wrapper {
      display: flex; align-items: center; gap: 0.5rem;
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 6px; padding: 0.5rem 0.75rem;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .color-input-wrapper:focus-within {
      border-color: var(--accent); box-shadow: 0 0 0 3px var(--focus-ring);
    }
    .color-preview-swatch {
      width: 36px; height: 36px; border-radius: 5px;
      border: 2px solid rgba(255,255,255,0.1); cursor: pointer; flex-shrink: 0;
    }
    #hexInput, #bgHexInput, #errorHexInput {
      background: transparent; border: none; color: #fff;
      font-size: 1.1rem; font-family: 'Cascadia Code','Fira Code',monospace;
      width: 8ch; outline: none;
    }
    #hexInput::placeholder, #bgHexInput::placeholder, #errorHexInput::placeholder { color: var(--text-faint); }
    #colorPicker, #bgColorPicker, #errorColorPicker { position: absolute; opacity: 0; width: 0; height: 0; }

    /* ── Color inputs container ────────────────────────────── */
    .color-inputs-container {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      border: 1px solid var(--border-hi); border-radius: 8px; overflow: hidden;
      margin-bottom: 1.25rem;
      transition: border-color 0.35s ease;
    }
    .color-input-col {
      display: flex; flex-direction: column; gap: 0.3rem;
      padding: 1rem 1.25rem;
    }
    .color-input-col:not(:last-child) { border-right: 1px solid var(--border-hi); }
    .color-col-label {
      font-size: 0.65rem; color: var(--text-dim); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.07em;
    }
    .color-col-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    .auto-btn {
      font-size: 0.6rem; padding: 0.15rem 0.45rem; border-radius: 3px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text-dim); cursor: pointer; font-family: inherit; font-weight: 600;
      transition: background 0.15s, color 0.15s, border-color 0.15s; letter-spacing: 0.04em;
    }
    .auto-btn.active { background: var(--accent-bg); color: var(--accent-text); border-color: var(--accent); }
    .input-info {
      font-size: 0.75rem; color: var(--text-dim);
      font-family: 'Cascadia Code','Fira Code',monospace;
    }
    .input-info span { color: var(--accent-text); }

    /* ── Mode switch ──────────────────────────────────────── */
    .mode-switch {
      display: flex; background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 5px; overflow: hidden;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .mode-option {
      padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600;
      cursor: pointer; transition: background 0.15s, color 0.15s;
      color: var(--text-dim); border: none; background: transparent;
      font-family: inherit; white-space: nowrap;
    }
    .mode-option:first-child { border-right: 1px solid var(--border); }
    .mode-option:hover { color: var(--text-mid); }
    .mode-option.active { background: var(--accent-bg); color: #fff; }
    .mode-hint { font-size: 0.7rem; color: var(--text-faint); font-style: italic; }

    /* ── Chroma slider ────────────────────────────────────── */
    .chroma-section { margin-bottom: 1.75rem; }
    .chroma-header { display: flex; flex-direction: column; align-items: flex-start; gap: 0.2rem; margin-bottom: 0.4rem; }
    .chroma-title { font-size: 1.15rem; color: var(--text-hi); font-weight: 600; }
    .chroma-hint-text { font-size: 0.7rem; color: var(--text-faint); font-style: italic; }
    .chroma-row {
      display: flex; align-items: center; gap: 1rem;
    }
    .chroma-label { font-size: 0.8rem; color: var(--text-dim); white-space: nowrap; }
    .chroma-input {
      background: transparent; border: none; color: var(--accent-text);
      font-size: 1.1rem; font-family: 'Cascadia Code','Fira Code',monospace;
      width: 4.5ch; outline: none; text-align: right; cursor: text;
    }
    .chroma-input:focus { color: #fff; }
    input[type=range] {
      flex: 1; -webkit-appearance: none; appearance: none;
      height: 4px; border-radius: 2px;
      background: var(--border); outline: none; cursor: pointer;
      transition: background 0.35s ease;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px;
      border-radius: 50%; background: var(--accent);
      border: 2px solid var(--bg-page);
      transition: background 0.35s ease, border-color 0.35s ease;
    }
    input[type=range]::-moz-range-thumb {
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); border: 2px solid var(--bg-page);
      transition: background 0.35s ease;
    }

    /* ── Section titles ───────────────────────────────────── */
    .section-title {
      font-size: 1.15rem; font-weight: 600; color: var(--text-hi);
      margin-top: 2.5rem; margin-bottom: 0.25rem;
    }
    .section-title.first { margin-top: 0; }
    .section-desc { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1rem; }

    /* ── Surface demo ─────────────────────────────────────── */
    .surface-demo {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem; margin-bottom: 2rem;
    }
    @media (max-width: 900px)  { .surface-demo { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 500px)  { .surface-demo { grid-template-columns: 1fr; } }
    .surface-panel { border-radius: 8px; padding: 1.1rem; min-height: 170px; }
    .surface-panel h3 { font-size: 0.8rem; margin-bottom: 0.6rem; font-weight: 600; }
    .surface-panel .mode-tag {
      font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.08em;
      opacity: 0.5; margin-bottom: 0.15rem;
    }
    .surface-card { border-radius: 12px; padding: 0.65rem 0.75rem; margin-bottom: 0.5rem; }
    .surface-card p { font-size: 0.65rem; opacity: 0.85; }
    .surface-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .surface-btn {
      display: inline-block; padding: 0.5rem 1.1rem; border-radius: 5px;
      font-size: 0.65rem; font-weight: 600; border: none; cursor: default;
      margin-top: 0.65rem; font-family: inherit; letter-spacing: 0.02em;
    }

    /* ── Detail table ─────────────────────────────────────── */
    table {
      width: 100%; border-collapse: collapse; font-size: 0.78rem;
      font-family: 'Cascadia Code','Fira Code',monospace; margin-bottom: 2rem;
    }
    th {
      text-align: left; padding: 0.45rem 0.65rem; border-bottom: 1px solid var(--border);
      color: var(--text-low); font-weight: 500; font-size: 0.65rem;
      text-transform: uppercase; letter-spacing: 0.08em;
    }
    td { padding: 0.45rem 0.65rem; border-bottom: 1px solid var(--border-sub); }
    tr:hover td { background: rgba(255,255,255,0.025); }
    .color-dot {
      width: 24px; height: 24px; border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.08); display: inline-block; vertical-align: middle;
    }
    .zone-tag {
      font-size: 0.55rem; padding: 1px 6px; border-radius: 3px;
      font-family: 'Segoe UI',system-ui,sans-serif; font-weight: 600;
      letter-spacing: 0.03em; white-space: nowrap;
    }
    .zone-tag.light { background: rgba(100,160,255,0.1); color: #6aa8e8; }
    .zone-tag.dark  { background: rgba(80,200,120,0.1);  color: #5cb87a; }
    .zone-tag.hc    { background: rgba(200,120,80,0.1);  color: #c88050; }

    .copyable {
      cursor: pointer; padding: 1px 5px; border-radius: 3px;
      transition: background 0.15s; position: relative; user-select: all;
    }
    .copyable:hover { background: rgba(255,255,255,0.08); }
    .copyable.copied { background: rgba(80,200,120,0.2) !important; }

    .toast {
      position: fixed; bottom: 1.5rem; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--toast-bg); color: #fff; padding: 0.6rem 1.2rem; border-radius: 5px;
      font-size: 0.8rem; font-family: 'Cascadia Code','Fira Code',monospace;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; z-index: 100;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .code-block {
      background: var(--bg-code); border: 1px solid var(--border); border-radius: 5px;
      padding: 1.1rem 1.25rem; font-family: 'Cascadia Code','Fira Code',monospace;
      font-size: 0.7rem; line-height: 1.6; overflow-x: auto; white-space: pre;
      color: var(--text-info); margin-bottom: 1rem; position: relative;
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .copy-block-btn {
      position: absolute; top: 0.6rem; right: 0.6rem;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-info); font-size: 0.65rem; padding: 0.3rem 0.6rem; border-radius: 4px;
      cursor: pointer; font-family: inherit; transition: background 0.15s, color 0.15s;
    }
    .copy-block-btn:hover { background: rgba(255,255,255,0.1); color: #ccc; }
    .copy-block-btn.copied { background: rgba(80,200,120,0.15); color: #6fc; border-color: rgba(80,200,120,0.3); }

    .tab-bar { display: flex; gap: 0; margin-bottom: 0; }
    .tab-btn {
      padding: 0.55rem 1.2rem; font-size: 0.75rem; font-weight: 600;
      background: transparent; border: 1px solid var(--border); border-bottom: none;
      color: var(--text-dim); cursor: pointer; border-radius: 5px 5px 0 0;
      transition: background 0.15s, color 0.15s; font-family: inherit;
    }
    .tab-btn:hover { color: var(--text-mid); background: rgba(255,255,255,0.02); }
    .tab-btn.active { color: #fff; background: var(--bg-surface); border-color: var(--border); }
    .tab-content {
      display: none; border: 1px solid var(--border); border-radius: 0 5px 5px 5px;
      padding: 1.5rem; background: var(--bg-surface);
      transition: background-color 0.35s ease, border-color 0.35s ease;
    }
    .tab-content.active { display: block; }
    .tab-content > table { margin-bottom: 0; }

    #output { display: none; }
    #output.visible { display: block; }
  </style>
</head>
<body>

  <h1>OKLCH Tonal Palette Generator</h1>
  <p class="subtitle">
    Enter a hex color code &rarr; automatically generates a <strong>Vibrant</strong> palette
    (full chroma), a <strong>Slated</strong> variant (50&nbsp;% chroma) and a <strong>Grey</strong> variant (pure grey) in the OKLCH color space.
  </p>

  <div class="color-inputs-container">
    <!-- Brand -->
    <div class="color-input-col">
      <span class="color-col-label">Brand</span>
      <div class="color-input-wrapper">
        <div class="color-preview-swatch" id="swatchPreview" style="background:#335A7F" onclick="document.getElementById('colorPicker').click()"></div>
        <input type="color" id="colorPicker" value="#335A7F">
        <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
        <input type="text" id="hexInput" value="335A7F" placeholder="335A7F" maxlength="7" spellcheck="false">
      </div>
      <div class="input-info" id="oklchInfo"></div>
    </div>
    <!-- Surface -->
    <div class="color-input-col">
      <div class="color-col-header">
        <span class="color-col-label">Surface</span>
        <button class="auto-btn active" id="bgAutoBtn" onclick="toggleBgAutoMatch()">Auto</button>
      </div>
      <div class="color-input-wrapper">
        <div class="color-preview-swatch" id="bgSwatchPreview" style="background:#335A7F" onclick="document.getElementById('bgColorPicker').click()"></div>
        <input type="color" id="bgColorPicker" value="#335A7F">
        <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
        <input type="text" id="bgHexInput" value="335A7F" placeholder="335A7F" maxlength="7" spellcheck="false">
      </div>
      <div class="input-info" id="bgOklchInfo"></div>
    </div>
    <!-- Error -->
    <div class="color-input-col">
      <div class="color-col-header">
        <span class="color-col-label">Error</span>
        <button class="auto-btn active" id="errorAutoBtn" onclick="toggleErrorAutoMatch()">Auto</button>
      </div>
      <div class="color-input-wrapper">
        <div class="color-preview-swatch" id="errorSwatchPreview" style="background:#CC3333" onclick="document.getElementById('errorColorPicker').click()"></div>
        <input type="color" id="errorColorPicker" value="#CC3333">
        <span style="color:var(--text-faint);font-size:1.1rem;font-family:monospace">#</span>
        <input type="text" id="errorHexInput" value="CC3333" placeholder="CC3333" maxlength="7" spellcheck="false">
      </div>
      <div class="input-info" id="errorOklchInfo"></div>
    </div>
  </div>
  <div class="controls-right">
    <div class="mode-switch">
      <button class="mode-option active" data-mode="balanced" onclick="setMode('balanced')">Balanced Midpoint</button>
      <button class="mode-option" data-mode="exact" onclick="setMode('exact')">Exact Brand Match</button>
    </div>
    <div class="mode-hint" id="modeHint">500 = perceptual midpoint (L=0.50) &mdash; palette is symmetric around the brightest point of the hue</div>
  </div>

  <div id="output">

    <!-- ── Chroma slider ───────────────────────────────────── -->
    <div class="chroma-section">
      <div class="chroma-header">
        <span class="chroma-title">Surface Chroma</span>
        <span class="chroma-hint-text">Sättigungsstärke für Hintergrund- und Surface-Tokens</span>
      </div>
      <div class="chroma-row">
        <span class="chroma-label">Grey</span>
        <input type="range" id="chromaSlider" min="0" max="100" value="25">
        <span class="chroma-label">Vibrant</span>
        <input type="text" class="chroma-input" id="chromaInput" value="25%" maxlength="4">
      </div>
    </div>

    <!-- ── Surface demo ────────────────────────────────────── -->
    <div class="surface-demo" id="surfaces-demo"></div>

    <!-- ── Brand / Background Tokens ──────────────────────── -->
    <div class="tab-group" style="margin-bottom:2rem">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="brand">Brand</button>
        <button class="tab-btn" data-tab="bg">Surface</button>
        <button class="tab-btn" data-tab="error">Error</button>
        <button class="tab-btn" data-tab="neutral">Neutral</button>
      </div>
      <div class="tab-content active" data-tab="brand">
        <p class="section-desc">Full chroma &mdash; accent colors, buttons, links</p>
        <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
          <tbody id="table-brand"></tbody>
        </table>
      </div>
      <div class="tab-content" data-tab="bg">
        <p class="section-desc">Surfaces &middot; containers &mdash; <span id="chromaDescValue">25%</span> chroma<span id="bgColorNote"></span></p>
        <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
          <tbody id="table-bg"></tbody>
        </table>
      </div>
      <div class="tab-content" data-tab="error">
        <p class="section-desc">Error / destructive states &mdash; full chroma</p>
        <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
          <tbody id="table-error"></tbody>
        </table>
      </div>
      <div class="tab-content" data-tab="neutral">
        <p class="section-desc">0% chroma &mdash; High Contrast surfaces &middot; #fff and #000 included</p>
        <table><thead><tr><th>Step</th><th>Color</th><th>Hex</th><th>OKLCH</th><th>L</th><th>C</th><th>Zone</th></tr></thead>
          <tbody id="table-neutral"></tbody>
        </table>
      </div>
    </div>

    <!-- ── Code blocks (always visible) ───────────────────── -->
    <h2 class="section-title">Export</h2>
    <p class="section-desc">Click the button in the top-right corner to copy the entire block</p>
    <div class="tab-group">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="oklch">Primitives OKLCH</button>
        <button class="tab-btn" data-tab="hex">Primitives Hex</button>
        <button class="tab-btn" data-tab="semantic">Semantic</button>
      </div>
      <div class="tab-content active" data-tab="oklch">
        <div class="code-block" id="code-oklch"><button class="copy-block-btn" onclick="copyBlock('code-oklch')">Copy</button></div>
      </div>
      <div class="tab-content" data-tab="hex">
        <div class="code-block" id="code-hex"><button class="copy-block-btn" onclick="copyBlock('code-hex')">Copy</button></div>
      </div>
      <div class="tab-content" data-tab="semantic">
        <div class="code-block" id="code-semantic"><button class="copy-block-btn" onclick="copyBlock('code-semantic')">Copy</button></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ================================================================
    //  OKLCH Color Math
    // ================================================================
    function srgbToLinear(c) {
      c /= 255;
      return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
    }
    function linearToSrgb(c) {
      c = Math.max(0, Math.min(1, c));
      return c <= 0.0031308 ? 12.92 * c : 1.055 * Math.pow(c, 1 / 2.4) - 0.055;
    }
    function linearSrgbToOklab(r, g, b) {
      let l_ = 0.4122214708*r + 0.5363325363*g + 0.0514459929*b;
      let m_ = 0.2119034982*r + 0.6806995451*g + 0.1073969566*b;
      let s_ = 0.0883024619*r + 0.2817188376*g + 0.6299787005*b;
      l_ = Math.cbrt(l_); m_ = Math.cbrt(m_); s_ = Math.cbrt(s_);
      return [
        0.2104542553*l_ + 0.7936177850*m_ - 0.0040720468*s_,
        1.9779984951*l_ - 2.4285922050*m_ + 0.4505937099*s_,
        0.0259040371*l_ + 0.7827717662*m_ - 0.8086757660*s_
      ];
    }
    function oklabToLinearSrgb(L, a, b) {
      let l_ = L + 0.3963377774*a + 0.2158037573*b;
      let m_ = L - 0.1055613458*a - 0.0638541728*b;
      let s_ = L - 0.0894841775*a - 1.2914855480*b;
      l_=l_*l_*l_; m_=m_*m_*m_; s_=s_*s_*s_;
      return [
        +4.0767416621*l_ - 3.3077115913*m_ + 0.2309699292*s_,
        -1.2684380046*l_ + 2.6097574011*m_ - 0.3413193965*s_,
        -0.0041960863*l_ - 0.7034186147*m_ + 1.7076147010*s_
      ];
    }
    function oklabToOklch(L, a, b) {
      return [L, Math.sqrt(a*a + b*b), ((Math.atan2(b, a) * 180 / Math.PI) % 360 + 360) % 360];
    }
    function oklchToOklab(L, C, H) {
      const rad = H * Math.PI / 180;
      return [L, C * Math.cos(rad), C * Math.sin(rad)];
    }
    function hexToRgb(hex) {
      hex = hex.replace('#','');
      return [parseInt(hex.substring(0,2),16), parseInt(hex.substring(2,4),16), parseInt(hex.substring(4,6),16)];
    }
    function rgbToHex(r, g, b) {
      const clamp = v => Math.max(0, Math.min(255, Math.round(v)));
      return '#' + [r,g,b].map(v => clamp(v).toString(16).padStart(2,'0').toUpperCase()).join('');
    }
    function hexToOklch(hex) {
      const [r,g,b] = hexToRgb(hex);
      const [lr,lg,lb] = [srgbToLinear(r), srgbToLinear(g), srgbToLinear(b)];
      const [L,a,b2] = linearSrgbToOklab(lr, lg, lb);
      return oklabToOklch(L, a, b2);
    }
    function oklchToHex(L, C, H) {
      const [_,a,b] = oklchToOklab(L, C, H);
      const [r,g,b2] = oklabToLinearSrgb(L, a, b);
      return rgbToHex(linearToSrgb(r)*255, linearToSrgb(g)*255, linearToSrgb(b2)*255);
    }
    function isInGamut(L, C, H) {
      const [_,a,b] = oklchToOklab(L, C, H);
      const [r,g,b2] = oklabToLinearSrgb(L, a, b);
      return r >= -0.001 && r <= 1.001 && g >= -0.001 && g <= 1.001 && b2 >= -0.001 && b2 <= 1.001;
    }
    function maxChromaInGamut(L, H) {
      if (L <= 0.001 || L >= 0.999) return 0;
      let lo = 0, hi = 0.4;
      while (hi - lo > 0.0005) {
        const mid = (lo + hi) / 2;
        if (isInGamut(L, mid, H)) lo = mid; else hi = mid;
      }
      return lo;
    }

    // ================================================================
    //  Palette Generation
    // ================================================================
    const STEPS = [25, 50, 75, 100, 200, 300, 400, 500, 600, 700, 800, 825, 850, 875, 900, 925, 950, 975];
    const L_WHITE = 0.98, L_BLACK = 0.10;

    let currentMode = 'balanced'; // 'balanced' or 'exact'
    let chromaScale = 0.25;      // background palette chroma (0–1)
    let bgColorHex = '#335A7F';  // default = initial primary
    let bgAutoMatch = true;
    let errorColorHex = '#CC3333'; // placeholder, overwritten on first generate if auto
    let errorAutoMatch = true;

    function computeAutoErrorHex(primaryHex) {
      const [pL, pC, pH] = hexToOklch(primaryHex);
      const ERROR_HUE = 25; // warm red
      const primaryMaxC = maxChromaInGamut(pL, pH);
      const saturation = primaryMaxC > 0.001 ? pC / primaryMaxC : 0.5;
      const errorMaxC = maxChromaInGamut(pL, ERROR_HUE);
      return oklchToHex(pL, errorMaxC * saturation * 0.95, ERROR_HUE);
    }

    function toggleBgAutoMatch() {
      bgAutoMatch = !bgAutoMatch;
      document.getElementById('bgAutoBtn').classList.toggle('active', bgAutoMatch);
      if (bgAutoMatch) generate();
    }

    function toggleErrorAutoMatch() {
      errorAutoMatch = !errorAutoMatch;
      document.getElementById('errorAutoBtn').classList.toggle('active', errorAutoMatch);
      if (errorAutoMatch) generate();
    }

    function generatePalette(hex, chromaScale = 1.0) {
      const [bL, bC, bH] = hexToOklch(hex);

      const inputMaxC = maxChromaInGamut(bL, bH);
      const saturation = inputMaxC > 0.001 ? bC / inputMaxC : 0;
      const blend = Math.min(1, saturation / 0.3);
      const safeH = bC > 0.005 ? bH : 0;

      // ── Mode-dependent: determine L_MID for step 500 ──
      const L_MID = currentMode === 'exact' ? bL : 0.50;

      function stepToL(step) {
        if (step <= 500) return L_WHITE + (step / 500) * (L_MID - L_WHITE);
        return L_MID + ((step - 500) / 500) * (L_BLACK - L_MID);
      }

      // ── Mode-dependent: chroma strategy ──
      if (currentMode === 'exact') {
        return STEPS.map(step => {
          const L = stepToL(step);
          const H = safeH;
          let C;

          if (step === 500) {
            C = bC * chromaScale;
          } else {
            const stepNorm = step <= 500 ? step / 500 : (1000 - step) / 500;
            const envelope = 1 - Math.pow(1 - stepNorm, 2);
            const desired = bC * chromaScale * envelope;
            const gamutMax = bC > 0.005 ? maxChromaInGamut(L, safeH) : 0;
            C = Math.min(desired, gamutMax * 0.95);
          }

          const hx = oklchToHex(L, C, H);
          const css = `oklch(${L.toFixed(4)} ${C.toFixed(4)} ${H.toFixed(2)})`;
          return { step, L, C, H, hex: hx, css };
        });
      }

      // BALANCED MODE
      const maxC500 = maxChromaInGamut(L_MID, safeH);
      const targetC500 = maxC500 * 0.88 * blend;

      return STEPS.map(step => {
        const L = stepToL(step);
        const envelope = 1 - Math.pow(2 * L - 1, 2);
        const desired = targetC500 * chromaScale * Math.max(0, envelope);
        const gamutMax = bC > 0.005 ? maxChromaInGamut(L, safeH) : 0;
        const C = Math.min(desired, gamutMax * 0.95);
        const H = safeH;
        const hx = oklchToHex(L, C, H);
        const css = `oklch(${L.toFixed(4)} ${C.toFixed(4)} ${H.toFixed(2)})`;
        return { step, L, C, H, hex: hx, css };
      });
    }

    // ================================================================
    //  Rendering
    // ================================================================
    function getZone(step, showHC = false) {
      if (step === 0)    return showHC ? { label: 'HC White', cls: 'hc' } : null;
      if (step === 1000) return showHC ? { label: 'HC Black', cls: 'hc' } : null;
      if (step <= 100)   return { label: 'Light Surfaces', cls: 'light' };
      if (step >= 825 && step <= 875) return { label: 'Dark Surfaces', cls: 'dark' };
      if (step >= 900 && showHC) return { label: 'High Contrast', cls: 'hc' };
      return null;
    }

function renderTable(tbodyId, palette, showHC = false) {
      document.getElementById(tbodyId).innerHTML = palette.map(r => {
        const is500 = r.step === 500;
        const bg = is500 ? ' style="background:rgba(255,255,255,0.04)"' : '';
        const b = is500 ? s => `<strong>${s}</strong>` : s => s;
        const zone = getZone(r.step, showHC);
        const zt = zone ? `<span class="zone-tag ${zone.cls}">${zone.label}</span>` : '';
        const dotOutline = is500 ? ';outline:2px solid rgba(255,255,255,0.5)' : '';
        return `<tr${bg}>
          <td>${b(r.step)}</td>
          <td><div class="color-dot" style="background:${r.hex}${dotOutline}"></div></td>
          <td><span class="copyable" onclick="copyValue(this)" data-value="${r.hex}">${b(r.hex)}</span></td>
          <td><span class="copyable" onclick="copyValue(this)" data-value="${r.css}">${b(r.css)}</span></td>
          <td>${b(r.L.toFixed(3))}</td>
          <td>${b(r.C.toFixed(3))}</td>
          <td>${zt}</td>
        </tr>`;
      }).join('');
    }

    function renderSurfaces(containerId, palette, slatedPalette, neutral, accentSwatch, errorSwatch) {
      const s = {}; palette.forEach(r => s[r.step] = r);
      const n = {}; neutral.forEach(r => n[r.step] = r);
      const btnBg  = accentSwatch.hex;
      const btnFg  = accentSwatch.L < 0.55 ? '#fff' : '#111';
      const errBg  = errorSwatch.hex;
      const errFg  = errorSwatch.L < 0.55 ? '#fff' : '#111';
      const textLight = s[850].hex;  // Normal light: softened text from bg palette
      const textDark  = s[75].hex;   // Normal dark: light text from bg palette
      const btns = `<div class="surface-btns">
          <div class="surface-btn" style="background:${btnBg};color:${btnFg}">Primary</div>
          <div class="surface-btn" style="background:${errBg};color:${errFg}">Error</div>
        </div>`;
      document.getElementById(containerId).innerHTML = `
        <div class="surface-panel" style="background:${s[100].hex};color:${textLight}">
          <div class="mode-tag">Light</div><h3>Surfaces (25&ndash;100)</h3>
          <div class="surface-card" style="background:${s[25].hex}"><p><strong>Card (25)</strong> on BG (100)</p></div>
          <div class="surface-card" style="background:${s[50].hex}"><p><strong>Elevated (50)</strong> on BG (100)</p></div>
          <div class="surface-card" style="background:${s[75].hex}"><p><strong>Active (75)</strong> on BG (100)</p></div>
          ${btns}
        </div>
        <div class="surface-panel" style="background:${s[875].hex};color:${textDark}">
          <div class="mode-tag">Dark</div><h3>Surfaces (800&ndash;875)</h3>
          <div class="surface-card" style="background:${s[800].hex}"><p><strong>Card (800)</strong> on BG (875)</p></div>
          <div class="surface-card" style="background:${s[825].hex}"><p><strong>Elevated (825)</strong> on BG (875)</p></div>
          <div class="surface-card" style="background:${s[850].hex}"><p><strong>Active (850)</strong> on BG (875)</p></div>
          ${btns}
        </div>
        <div class="surface-panel" style="background:${n[75].hex};color:#000000">
          <div class="mode-tag">Light &middot; High Contrast</div><h3>Neutral Surfaces</h3>
          <div class="surface-card" style="background:#ffffff"><p><strong>Card (#fff)</strong> on BG (n75)</p></div>
          <div class="surface-card" style="background:${n[25].hex}"><p><strong>Elevated (n25)</strong> on BG (n75)</p></div>
          <div class="surface-card" style="background:${n[50].hex}"><p><strong>Active (n50)</strong> on BG (n75)</p></div>
          ${btns}
        </div>
        <div class="surface-panel" style="background:#000000;color:#ffffff">
          <div class="mode-tag">Dark &middot; High Contrast</div><h3>Neutral Surfaces</h3>
          <div class="surface-card" style="background:${n[975].hex}"><p><strong>Card (n975)</strong> on BG (#000)</p></div>
          <div class="surface-card" style="background:${n[950].hex}"><p><strong>Elevated (n950)</strong> on BG (#000)</p></div>
          <div class="surface-card" style="background:${n[925].hex}"><p><strong>Active (n925)</strong> on BG (#000)</p></div>
          ${btns}
        </div>`;
    }

    function renderCodeBlocks(brand, bg, error, errorSlated, neutral, customBgHex = null) {
      const pct = Math.round(chromaScale * 100);
      const bgLabel = customBgHex ? `${pct}% chroma — base ${customBgHex}` : `${pct}% chroma`;
      const neutralExt = [
        { step: 0,    L: 1, C: 0, H: 0, hex: '#FFFFFF', css: 'oklch(1 0 0)' },
        ...neutral,
        { step: 1000, L: 0, C: 0, H: 0, hex: '#000000', css: 'oklch(0 0 0)' }
      ];

      const cmt = t => `\n  <span class="cmt">/* ${t} */</span>\n`;

      // ── Primitives OKLCH ──
      const oklchBlock = document.getElementById('code-oklch');
      const btn1 = oklchBlock.querySelector('.copy-block-btn').outerHTML;
      let o = `<span class="cmt">/* Primitive Tokens */</span>\n:root {\n`;
      o += cmt('Brand') + fmtSec(brand, 'brand', 'css');
      o += cmt(`Surface — ${bgLabel}`) + fmtSec(bg, 'surface', 'css');
      o += cmt('Error') + fmtSec(error, 'error', 'css');
      o += cmt(`Error Surface — ${pct}% chroma`) + fmtSec(errorSlated, 'error-surface', 'css');
      o += cmt('Neutral') + fmtSec(neutralExt, 'neutral', 'css');
      o += `}`; oklchBlock.innerHTML = btn1 + o;

      // ── Primitives Hex ──
      const hexBlock = document.getElementById('code-hex');
      const btn2 = hexBlock.querySelector('.copy-block-btn').outerHTML;
      let h = `<span class="cmt">/* Primitive Tokens (Hex) */</span>\n:root {\n`;
      h += cmt('Brand') + fmtSec(brand, 'brand', 'hex');
      h += cmt(`Surface — ${bgLabel}`) + fmtSec(bg, 'surface', 'hex');
      h += cmt('Error') + fmtSec(error, 'error', 'hex');
      h += cmt(`Error Surface — ${pct}% chroma`) + fmtSec(errorSlated, 'error-surface', 'hex');
      h += cmt('Neutral') + fmtSec(neutralExt, 'neutral', 'hex');
      h += `}`; hexBlock.innerHTML = btn2 + h;

      // ── Semantic ──
      const semBlock = document.getElementById('code-semantic');
      const btn3 = semBlock.querySelector('.copy-block-btn').outerHTML;
      semBlock.innerHTML = btn3 + renderSemantic(brand, bg, error, errorSlated);
    }

    function renderSemantic(brand, surface, error, errorSlated) {
      const b  = {}; brand.forEach(r       => b[r.step]  = r);
      const s  = {}; surface.forEach(r     => s[r.step]  = r);
      const e  = {}; error.forEach(r       => e[r.step]  = r);
      const es = {}; errorSlated.forEach(r => es[r.step] = r);

      const v    = r    => `<span class="val">${r.css}</span>`;
      const prop = name => `  <span class="prop">--${name}</span>`;
      const line = (name, r) => `${prop(name)}: ${v(r)};\n`;
      const cmt  = t    => `  <span class="cmt">/* ${t} */</span>\n`;

      const block = (sel, rows) => {
        let o = `${sel} {\n`;
        rows.forEach(([name, r]) => { o += Array.isArray(r) ? cmt(r[0]) : line(name, r); });
        return o + `}\n`;
      };

      const root = block(':root', [
        [null, ['Base']],
        ['background',              s[50]],
        ['foreground',              s[975]],
        [null, ['Card']],
        ['card',                    s[25]],
        ['card-foreground',         s[975]],
        [null, ['Popover']],
        ['popover',                 s[25]],
        ['popover-foreground',      s[975]],
        [null, ['Primary']],
        ['primary',                 b[600]],
        ['primary-foreground',      b[50]],
        [null, ['Secondary — softened brand']],
        ['secondary',               b[200]],
        ['secondary-foreground',    b[900]],
        [null, ['Muted']],
        ['muted',                   s[75]],
        ['muted-foreground',        s[700]],
        [null, ['Accent']],
        ['accent',                  b[100]],
        ['accent-foreground',       b[950]],
        [null, ['Destructive']],
        ['destructive',             e[600]],
        ['destructive-foreground',  es[100]],
        [null, ['Border / Input / Ring']],
        ['border',                  s[400]],
        ['input',                   s[300]],
        ['ring',                    s[400]],
        [null, ['Sidebar']],
        ['sidebar',                         s[25]],
        ['sidebar-foreground',              s[975]],
        ['sidebar-primary',                 b[600]],
        ['sidebar-primary-foreground',      b[50]],
        ['sidebar-accent',                  b[100]],
        ['sidebar-accent-foreground',       b[950]],
        ['sidebar-border',                  s[400]],
        ['sidebar-ring',                    s[400]],
      ]);

      const dark = block('.dark', [
        [null, ['Base']],
        ['background',              s[850]],
        ['foreground',              s[25]],
        [null, ['Card']],
        ['card',                    s[875]],
        ['card-foreground',         s[25]],
        [null, ['Popover']],
        ['popover',                 s[875]],
        ['popover-foreground',      s[25]],
        [null, ['Primary']],
        ['primary',                 b[400]],
        ['primary-foreground',      b[975]],
        [null, ['Secondary — softened brand']],
        ['secondary',               b[800]],
        ['secondary-foreground',    b[100]],
        [null, ['Muted']],
        ['muted',                   s[825]],
        ['muted-foreground',        s[300]],
        [null, ['Accent']],
        ['accent',                  b[800]],
        ['accent-foreground',       b[50]],
        [null, ['Destructive']],
        ['destructive',             e[400]],
        ['destructive-foreground',  es[900]],
        [null, ['Border / Input / Ring']],
        ['border',                  s[600]],
        ['input',                   s[700]],
        ['ring',                    s[600]],
        [null, ['Sidebar']],
        ['sidebar',                         s[875]],
        ['sidebar-foreground',              s[25]],
        ['sidebar-primary',                 b[400]],
        ['sidebar-primary-foreground',      b[975]],
        ['sidebar-accent',                  b[800]],
        ['sidebar-accent-foreground',       b[50]],
        ['sidebar-border',                  s[600]],
        ['sidebar-ring',                    s[600]],
      ]);

      return `<span class="cmt">/* Semantic Tokens — shadcn/ui compatible */</span>\n` + root + '\n' + dark;
    }

    function fmtSec(palette, prefix, mode) {
      const gs = [
        { l: 'Light Surfaces', f: r => r.step <= 100 },
        { l: 'Core', f: r => r.step >= 200 && r.step <= 800 },
        { l: 'Dark Surfaces (normal)', f: r => r.step >= 825 && r.step <= 875 },
        { l: 'Dark Surfaces (high contrast)', f: r => r.step >= 900 },
      ];
      let out = '';
      gs.forEach((g, i) => {
        if (i > 0) out += '\n';
        out += `  <span class="cmt">/* ${g.l} */</span>\n`;
        palette.filter(g.f).forEach(r => {
          const v = mode === 'css' ? r.css : r.hex;
          out += `  <span class="prop">--color-${prefix}-${r.step}</span>: <span class="val">${v}</span>;\n`;
        });
      });
      return out;
    }

    // ================================================================
    //  Theme update — Dark HC palette drives page chrome
    // ================================================================
    function updateTheme(vibrant, slated, neutral) {
      const v  = {}; vibrant.forEach(r => v[r.step]  = r);
      const sl = {}; slated.forEach(r  => sl[r.step] = r);
      const n  = {}; neutral.forEach(r => n[r.step]  = r);
      const root = document.documentElement;

      root.style.setProperty('--bg-page',     n[975].hex);
      root.style.setProperty('--bg-surface',  n[950].hex);
      root.style.setProperty('--bg-code',     n[975].hex);
      root.style.setProperty('--border',      n[900].hex);
      root.style.setProperty('--border-sub',  n[925].hex);
      root.style.setProperty('--border-hi',   n[800].hex);
      root.style.setProperty('--toast-bg',    n[900].hex);

      root.style.setProperty('--text-hi',     sl[75].hex);
      root.style.setProperty('--text-mid',    sl[200].hex);
      root.style.setProperty('--text-low',    sl[300].hex);
      root.style.setProperty('--text-dim',    sl[400].hex);
      root.style.setProperty('--text-faint',  sl[500].hex);
      root.style.setProperty('--text-info',   sl[200].hex);

      root.style.setProperty('--accent',      v[500].hex);
      root.style.setProperty('--accent-bg',   v[800].hex);
      root.style.setProperty('--accent-text', v[300].hex);

      const h = v[500].hex.replace('#', '');
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      root.style.setProperty('--focus-ring', `rgba(${r},${g},${b},0.2)`);
    }

    // ================================================================
    //  Mode switch
    // ================================================================
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-option').forEach(b => {
        b.classList.toggle('active', b.dataset.mode === mode);
      });
      document.getElementById('modeHint').innerHTML = mode === 'balanced'
        ? '500 = perceptual midpoint (L=0.50) &mdash; palette is symmetric around the brightest point of the hue'
        : '500 = exactly your input color &mdash; lightness + chroma are scaled evenly around it';
      generate();
    }

    // ================================================================
    //  Main
    // ================================================================
    function generate() {
      const raw = document.getElementById('hexInput').value.replace(/#/g,'').trim();
      if (!/^[0-9a-fA-F]{6}$/.test(raw)) {
        showToast('Please enter a valid 6-digit hex code');
        return;
      }
      const hex = '#' + raw.toUpperCase();
      const [bL, bC, bH] = hexToOklch(hex);

      document.getElementById('swatchPreview').style.background = hex;
      document.getElementById('colorPicker').value = hex;

      const inputMaxC = maxChromaInGamut(bL, bH);
      const sat = inputMaxC > 0.001 ? (bC / inputMaxC * 100).toFixed(0) : 0;
      const satLabel = sat < 5 ? ' (neutral)' : sat < 30 ? ' (muted)' : '';
      document.getElementById('oklchInfo').innerHTML =
        `OKLCH: <span>L=${bL.toFixed(4)}</span>  <span>C=${bC.toFixed(4)}</span>  <span>H=${bH.toFixed(2)}&deg;</span>  <span style="color:#999">Sat: ${sat}%${satLabel}</span>`;

      // Surface auto-match: mirror primary
      if (bgAutoMatch) {
        bgColorHex = hex;
        document.getElementById('bgHexInput').value = raw.toUpperCase();
        document.getElementById('bgSwatchPreview').style.background = hex;
        document.getElementById('bgColorPicker').value = hex;
      }

      // Background OKLCH info
      const [bgL, bgC, bgH] = hexToOklch(bgColorHex);
      const bgMaxC = maxChromaInGamut(bgL, bgH);
      const bgSat = bgMaxC > 0.001 ? (bgC / bgMaxC * 100).toFixed(0) : 0;
      const bgSatLabel = bgSat < 5 ? ' (neutral)' : bgSat < 30 ? ' (muted)' : '';
      document.getElementById('bgOklchInfo').innerHTML =
        `OKLCH: <span>L=${bgL.toFixed(4)}</span>  <span>C=${bgC.toFixed(4)}</span>  <span>H=${bgH.toFixed(2)}&deg;</span>  <span style="color:#999">Sat: ${bgSat}%${bgSatLabel}</span>`;
      document.getElementById('bgColorNote').textContent =
        bgColorHex.toLowerCase() !== hex.toLowerCase() ? ` · ${bgColorHex}` : '';

      // Error color (auto-match if enabled)
      if (errorAutoMatch) {
        errorColorHex = computeAutoErrorHex(hex);
        document.getElementById('errorHexInput').value = errorColorHex.replace('#', '');
        document.getElementById('errorSwatchPreview').style.background = errorColorHex;
        document.getElementById('errorColorPicker').value = errorColorHex;
      }
      const [eL, eC, eH] = hexToOklch(errorColorHex);
      const eMaxC = maxChromaInGamut(eL, eH);
      const eSat = eMaxC > 0.001 ? (eC / eMaxC * 100).toFixed(0) : 0;
      const eSatLabel = eSat < 5 ? ' (neutral)' : eSat < 30 ? ' (muted)' : '';
      document.getElementById('errorOklchInfo').innerHTML =
        `OKLCH: <span>L=${eL.toFixed(4)}</span>  <span>C=${eC.toFixed(4)}</span>  <span>H=${eH.toFixed(2)}&deg;</span>  <span style="color:#999">Sat: ${eSat}%${eSatLabel}</span>`;

      const brand        = generatePalette(hex, 1.0);
      const bg           = generatePalette(bgColorHex, chromaScale);
      const error        = generatePalette(errorColorHex, 1.0);
      const errorSlated  = generatePalette(errorColorHex, chromaScale);
      const neutral      = generatePalette(bgColorHex, 0.0);
      const slated       = generatePalette(bgColorHex, 0.5);

      const c500brand = brand.find(r => r.step === 500);
      const c500error = error.find(r => r.step === 500);
      const neutralExtended = [
        { step: 0,    L: 1, C: 0, H: 0, hex: '#FFFFFF', css: 'oklch(1 0 0)' },
        ...neutral,
        { step: 1000, L: 0, C: 0, H: 0, hex: '#000000', css: 'oklch(0 0 0)' }
      ];

      updateTheme(brand, slated, neutral);
      renderTable('table-brand', brand);
      renderTable('table-bg', bg);
      renderTable('table-error', error);
      renderTable('table-neutral', neutralExtended, true);
      renderSurfaces('surfaces-demo', bg, slated, neutral, c500brand, c500error);
      renderCodeBlocks(brand, bg, error, errorSlated, neutral, bgColorHex.toLowerCase() !== hex.toLowerCase() ? bgColorHex : null);
      document.getElementById('output').classList.add('visible');
    }

    // ================================================================
    //  Events
    // ================================================================
    document.getElementById('colorPicker').addEventListener('input', e => {
      document.getElementById('hexInput').value = e.target.value.replace('#','').toUpperCase();
      document.getElementById('swatchPreview').style.background = e.target.value;
      generate();
    });
    document.getElementById('hexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('hexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        document.getElementById('swatchPreview').style.background = '#' + cleaned;
        document.getElementById('colorPicker').value = '#' + cleaned;
        generate();
      }
    });

    // Surface color inputs
    document.getElementById('bgColorPicker').addEventListener('input', e => {
      bgAutoMatch = false;
      document.getElementById('bgAutoBtn').classList.remove('active');
      bgColorHex = e.target.value.toUpperCase();
      document.getElementById('bgHexInput').value = bgColorHex.replace('#', '');
      document.getElementById('bgSwatchPreview').style.background = bgColorHex;
      generate();
    });
    document.getElementById('bgHexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('bgHexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        bgAutoMatch = false;
        document.getElementById('bgAutoBtn').classList.remove('active');
        bgColorHex = '#' + cleaned.toUpperCase();
        document.getElementById('bgSwatchPreview').style.background = bgColorHex;
        document.getElementById('bgColorPicker').value = bgColorHex;
        generate();
      }
    });

    // Error color inputs
    document.getElementById('errorColorPicker').addEventListener('input', e => {
      errorAutoMatch = false;
      document.getElementById('errorAutoBtn').classList.remove('active');
      errorColorHex = e.target.value.toUpperCase();
      document.getElementById('errorHexInput').value = errorColorHex.replace('#', '');
      document.getElementById('errorSwatchPreview').style.background = errorColorHex;
      generate();
    });
    document.getElementById('errorHexInput').addEventListener('keydown', e => { if (e.key === 'Enter') generate(); });
    document.getElementById('errorHexInput').addEventListener('input', e => {
      const cleaned = e.target.value.replace(/#/g, '');
      if (cleaned !== e.target.value) e.target.value = cleaned;
      if (/^[0-9a-fA-F]{6}$/.test(cleaned)) {
        errorAutoMatch = false;
        document.getElementById('errorAutoBtn').classList.remove('active');
        errorColorHex = '#' + cleaned.toUpperCase();
        document.getElementById('errorSwatchPreview').style.background = errorColorHex;
        document.getElementById('errorColorPicker').value = errorColorHex;
        generate();
      }
    });

    // Chroma slider
    document.getElementById('chromaSlider').addEventListener('input', e => {
      chromaScale = e.target.value / 100;
      document.getElementById('chromaInput').value = e.target.value + '%';
      document.getElementById('chromaDescValue').textContent = e.target.value + '%';
      generate();
    });
    document.getElementById('chromaInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') e.target.blur();
    });
    document.getElementById('chromaInput').addEventListener('change', e => {
      const val = Math.round(Math.min(100, Math.max(0, parseFloat(e.target.value) || 0)));
      chromaScale = val / 100;
      document.getElementById('chromaSlider').value = val;
      e.target.value = val + '%';
      document.getElementById('chromaDescValue').textContent = val + '%';
      generate();
    });

    // Tabs (scoped per .tab-group)
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const group = btn.closest('.tab-group');
        group.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        group.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        group.querySelector(`.tab-content[data-tab="${btn.dataset.tab}"]`).classList.add('active');
      });
    });

    function copyValue(el) {
      navigator.clipboard.writeText(el.dataset.value).then(() => {
        showToast('Copied: ' + el.dataset.value);
        el.classList.add('copied');
        setTimeout(() => el.classList.remove('copied'), 1200);
      });
    }
    function copyBlock(id) {
      const block = document.getElementById(id);
      const text = block.innerText.replace(/^Copy\n?/, '').trim();
      const btn = block.querySelector('.copy-block-btn');
      navigator.clipboard.writeText(text).then(() => {
        showToast('Block copied!');
        btn.textContent = 'Copied!'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
      });
    }
    let toastTimer;
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('show'), 2000);
    }

    generate();
  </script>
</body>
</html>
